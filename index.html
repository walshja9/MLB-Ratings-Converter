<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MLB The Show 25 Rating Converter</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      padding: 1rem;
      color: #e2e8f0;
    }
    
    @media (min-width: 768px) { body { padding: 2rem; } }
    
    .container { max-width: 1100px; margin: 0 auto; }
    
    .header { text-align: center; margin-bottom: 1.5rem; }
    .header h1 {
      font-size: 2.25rem;
      font-weight: 900;
      background: linear-gradient(90deg, #ef4444, #ffffff, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.25rem;
    }
    .header h2 { font-size: 1.25rem; font-weight: 700; color: #cbd5e1; }
    
    .card {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(8px);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 1px solid #334155;
    }
    
    .form-row { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    
    .form-group label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.25rem; }
    
    .form-group input, .form-group select {
      padding: 0.5rem 0.75rem;
      background: #334155;
      border: 1px solid #475569;
      border-radius: 0.375rem;
      color: white;
      font-size: 0.875rem;
      outline: none;
    }
    
    .form-group input:focus, .form-group select:focus { border-color: #3b82f6; }
    .form-group input[readonly] { background: #1e293b; color: #94a3b8; cursor: not-allowed; }
    .form-group input.disabled { opacity: 0.5; }
    .input-name { width: 11rem; }
    .input-season { width: 5rem; }
    
    .checkbox-group { display: flex; align-items: flex-end; padding-bottom: 0.25rem; }
    .checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem; color: #cbd5e1; }
    .checkbox-label input { width: 1rem; height: 1rem; accent-color: #3b82f6; }
    
    .fields-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    @media (min-width: 768px) { .fields-grid { grid-template-columns: repeat(7, 1fr); } }
    .fields-grid input { width: 100%; padding: 0.375rem 0.5rem; }
    
    .btn-row { display: flex; align-items: center; gap: 1rem; }
    
    .btn-primary {
      padding: 0.5rem 1.5rem;
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary:hover { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
    
    .btn-secondary {
      width: 100%;
      padding: 0.5rem 1rem;
      background: #334155;
      color: white;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: background 0.2s;
    }
    .btn-secondary:hover { background: #475569; }
    
    .hint { font-size: 0.75rem; color: #64748b; }
    .hidden { display: none !important; }
    
    .results-grid { display: flex; flex-direction: column; gap: 1.5rem; }
    @media (min-width: 768px) { .results-grid { flex-direction: row; } .results-left { width: 33.333%; } .results-right { width: 66.666%; } }
    
    .player-card-wrapper { padding: 4px; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
    .player-card { background: #0f172a; border-radius: 0.5rem; padding: 1rem; text-align: center; }
    .player-card h3 { font-size: 1.5rem; font-weight: 700; color: white; }
    .player-card .meta { font-size: 0.875rem; color: #94a3b8; }
    .player-card .overall { font-size: 3.75rem; font-weight: 900; color: white; margin: 1rem 0; }
    .player-card .tier { font-size: 1.125rem; }
    .player-card .rp { font-size: 0.875rem; color: #94a3b8; margin-top: 0.5rem; }
    
    .ratings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .ratings-section { background: rgba(15, 23, 42, 0.5); border-radius: 0.5rem; padding: 1rem; }
    .ratings-section h4 { color: white; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .ratings-section h4.mt { margin-top: 1rem; }
    
    .rating-row { display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; }
    .rating-row .label { font-size: 0.875rem; color: #94a3b8; }
    .rating-row .value { font-weight: 700; }
    
    .color-diamond { color: #facc15; }
    .color-gold { color: #a855f7; }
    .color-silver { color: #60a5fa; }
    .color-bronze { color: #4ade80; }
    .color-common { color: #9ca3af; }
    
    .tier-diamond { background: linear-gradient(135deg, #22d3ee, #3b82f6); }
    .tier-gold { background: linear-gradient(135deg, #facc15, #ca8a04); }
    .tier-silver { background: linear-gradient(135deg, #d1d5db, #6b7280); }
    .tier-bronze { background: linear-gradient(135deg, #fb923c, #ea580c); }
    .tier-common { background: linear-gradient(135deg, #6b7280, #374151); }
    
    details { margin-top: 1rem; }
    summary { font-size: 0.875rem; color: #94a3b8; cursor: pointer; transition: color 0.2s; }
    summary:hover { color: #cbd5e1; }
    pre { margin-top: 0.5rem; padding: 0.75rem; background: #0f172a; border-radius: 0.375rem; font-size: 0.75rem; color: #cbd5e1; overflow: auto; border: 1px solid #334155; }
    .download-icon { width: 1.25rem; height: 1.25rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>MLB The Show 25</h1>
      <h2>Rating Converter</h2>
    </div>

    <div class="card">
      <div class="form-row">
        <div class="form-group">
          <label>Player Name</label>
          <input type="text" id="name" placeholder="Player Name" class="input-name">
        </div>
        <div class="form-group">
          <label>Season</label>
          <input type="text" id="season" placeholder="2025" class="input-season">
        </div>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="isCareer">
            <span>Career</span>
          </label>
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="playerType">
            <option value="hitter">Hitter</option>
            <option value="pitcher">Pitcher</option>
          </select>
        </div>
        <div class="form-group">
          <label>Era</label>
          <select id="playerEra">
            <option value="deadball">Dead Ball (pre-1920)</option>
            <option value="liveball">Live Ball (1920-1941)</option>
            <option value="integration">Integration (1947-1960)</option>
            <option value="expansion">Expansion (1961-1976)</option>
            <option value="freeagency">Free Agency/Steroid (1977-2005)</option>
            <option value="modern" selected>Modern (2006+)</option>
          </select>
        </div>
        <div class="form-group" id="positionContainer">
          <label>Position</label>
          <select id="playerPosition">
            <option value="C">C (Catcher)</option>
            <option value="1B">1B (First Base)</option>
            <option value="2B">2B (Second Base)</option>
            <option value="3B">3B (Third Base)</option>
            <option value="SS">SS (Shortstop)</option>
            <option value="LF">LF (Left Field)</option>
            <option value="CF">CF (Center Field)</option>
            <option value="RF" selected>RF (Right Field)</option>
            <option value="DH">DH (Designated Hitter)</option>
          </select>
        </div>
      </div>

      <div id="fieldsContainer" class="fields-grid"></div>

      <div class="btn-row">
        <button onclick="calculateRatings()" class="btn-primary">Calculate Ratings</button>
        <span class="hint">Rate stats (K/9, ISO, etc.) auto-calculate from counting stats</span>
      </div>
    </div>

    <div id="resultsContainer" class="card hidden">
      <div class="results-grid">
        <div class="results-left">
          <div id="cardContainer" class="player-card-wrapper">
            <div class="player-card">
              <h3 id="resultName">Player</h3>
              <p class="meta" id="resultMeta">2025 ‚Ä¢ hitter</p>
              <div class="overall" id="resultOverall">0</div>
              <div class="tier" id="resultTier"></div>
              <div class="rp hidden" id="resultRP"></div>
            </div>
          </div>
          <button onclick="downloadCSV()" class="btn-secondary" style="margin-top: 1rem;">
            <svg class="download-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Export CSV
          </button>
        </div>
        <div class="results-right">
          <div id="ratingsContainer" class="ratings-grid"></div>
        </div>
      </div>
      <details>
        <summary>View Raw Stats</summary>
        <pre id="rawStats"></pre>
      </details>
    </div>
  </div>

<script>
let playerData = null, ratings = null;

const hitterFields = [
  { key: 'avg', label: 'AVG', placeholder: '.300' }, { key: 'avg_vs_r', label: 'AVG vR', placeholder: '.310' },
  { key: 'avg_vs_l', label: 'AVG vL', placeholder: '.280' }, { key: 'obp', label: 'OBP', placeholder: '.380' },
  { key: 'slg', label: 'SLG', placeholder: '.500' }, { key: 'slg_vs_r', label: 'SLG vR', placeholder: '.520' },
  { key: 'slg_vs_l', label: 'SLG vL', placeholder: '.460' }, { key: 'iso', label: 'ISO', placeholder: 'auto', auto: true },
  { key: 'iso_vs_r', label: 'ISO vR', placeholder: 'auto', auto: true }, { key: 'iso_vs_l', label: 'ISO vL', placeholder: 'auto', auto: true },
  { key: 'hr', label: 'HR', placeholder: '30' }, { key: 'sb', label: 'SB', placeholder: '10' },
  { key: 'k_pct', label: 'K%', placeholder: '20.0' }, { key: 'bb_pct', label: 'BB%', placeholder: '10.0' },
  { key: 'sprint_speed', label: 'Sprint', placeholder: '27.0' }, { key: 'oaa', label: 'OAA', placeholder: '5' },
  { key: 'drs', label: 'DRS', placeholder: '5' }, { key: 'fielding_pct', label: 'Fld%', placeholder: '.980' },
  { key: 'games', label: 'G', placeholder: '150' }
];

const pitcherFields = [
  { key: 'era', label: 'ERA', placeholder: '3.50' }, { key: 'whip', label: 'WHIP', placeholder: '1.20' },
  { key: 'ip', label: 'IP', placeholder: '180' }, { key: 'k', label: 'K', placeholder: '200' },
  { key: 'bb', label: 'BB', placeholder: '50' }, { key: 'h', label: 'H', placeholder: '150' },
  { key: 'hr', label: 'HR', placeholder: '20' }, { key: 'k_9', label: 'K/9', placeholder: 'auto', auto: true },
  { key: 'bb_9', label: 'BB/9', placeholder: 'auto', auto: true }, { key: 'h_9', label: 'H/9', placeholder: 'auto', auto: true },
  { key: 'hr_9', label: 'HR/9', placeholder: 'auto', auto: true }, { key: 'fb_velo', label: 'Velo', placeholder: '95.0' },
  { key: 'whiff_pct', label: 'Whiff%', placeholder: '25.0' }, { key: 'games', label: 'G', placeholder: '32' }
];

const eraConfig = {
  deadball: { avgK9: 4.0, avgKPct: 10, spBase: -3, rpBase: 1, staminaMax: 400 },
  liveball: { avgK9: 4.5, avgKPct: 12, spBase: -2, rpBase: 1, staminaMax: 350 },
  integration: { avgK9: 5.0, avgKPct: 14, spBase: -1, rpBase: 1, staminaMax: 300 },
  expansion: { avgK9: 5.5, avgKPct: 15, spBase: 2, rpBase: 1, staminaMax: 280 },
  freeagency: { avgK9: 6.0, avgKPct: 16, spBase: 3, rpBase: 1, staminaMax: 250 },
  modern: { avgK9: 8.5, avgKPct: 22, spBase: 5, rpBase: 1, staminaMax: 220 },
};

const positionAdj = { 'C': 10, 'SS': 8, 'CF': 6, '2B': 5, '3B': 4, 'RF': 3, 'LF': 2, '1B': 2, 'DH': 0 };

const hasRateStat = (v) => v != null && v !== '' && parseFloat(v) > 0;
const hasCountStat = (v) => v != null && v !== '' && !isNaN(parseFloat(v));
const hasFieldingStat = (v) => v != null && v !== '' && !isNaN(parseFloat(v));
const num = (v) => parseFloat(v);
const toPct = (v) => { const n = parseFloat(v); return n > 1 ? n : n * 100; };
const scale = (value, min, max, inverse = false) => {
  if (value == null || isNaN(parseFloat(value))) return null;
  const v = parseFloat(value);
  const normalized = inverse ? (max - v) / (max - min) : (v - min) / (max - min);
  return Math.round(Math.max(0, Math.min(1, normalized)) * 100 + 25);
};
const getRatingColor = (v) => v >= 90 ? 'color-diamond' : v >= 80 ? 'color-gold' : v >= 70 ? 'color-silver' : v >= 60 ? 'color-bronze' : 'color-common';
const getTier = (v) => v >= 90 ? { label: 'Diamond', css: 'tier-diamond', icon: 'üíé' } : v >= 80 ? { label: 'Gold', css: 'tier-gold', icon: 'ü•á' } : v >= 70 ? { label: 'Silver', css: 'tier-silver', icon: 'ü•à' } : v >= 60 ? { label: 'Bronze', css: 'tier-bronze', icon: 'ü•â' } : { label: 'Common', css: 'tier-common', icon: '‚ö´' };

function buildFields() {
  const container = document.getElementById('fieldsContainer');
  const playerType = document.getElementById('playerType').value;
  const fields = playerType === 'pitcher' ? pitcherFields : hitterFields;
  container.innerHTML = fields.map(f => `<div class="form-group"><label>${f.label}</label><input type="text" id="field_${f.key}" placeholder="${f.placeholder}" ${f.auto ? 'readonly' : ''} oninput="autoCalculate()"></div>`).join('');
  document.getElementById('positionContainer').style.display = playerType === 'hitter' ? 'block' : 'none';
}

function autoCalculate() {
  const playerType = document.getElementById('playerType').value;
  if (playerType === 'pitcher') {
    const ip = parseFloat(document.getElementById('field_ip')?.value) || 0;
    if (ip > 0) ['k', 'bb', 'h', 'hr'].forEach(stat => { const val = parseFloat(document.getElementById(`field_${stat}`)?.value); if (!isNaN(val) && val >= 0) { const rateField = document.getElementById(`field_${stat}_9`); if (rateField) rateField.value = ((val / ip) * 9).toFixed(2); } });
  } else {
    [{ avg: 'avg', slg: 'slg', iso: 'iso' }, { avg: 'avg_vs_r', slg: 'slg_vs_r', iso: 'iso_vs_r' }, { avg: 'avg_vs_l', slg: 'slg_vs_l', iso: 'iso_vs_l' }].forEach(({ avg, slg, iso }) => { const avgVal = parseFloat(document.getElementById(`field_${avg}`)?.value), slgVal = parseFloat(document.getElementById(`field_${slg}`)?.value); if (avgVal > 0 && slgVal > 0) { const isoField = document.getElementById(`field_${iso}`); if (isoField) isoField.value = (slgVal - avgVal).toFixed(3); } });
  }
}

function getStats() {
  const playerType = document.getElementById('playerType').value;
  const fields = playerType === 'pitcher' ? pitcherFields : hitterFields;
  const stats = { name: document.getElementById('name').value, season: document.getElementById('isCareer').checked ? 'career' : (document.getElementById('season').value || '2025'), type: playerType, era_type: document.getElementById('playerEra').value, position: playerType === 'hitter' ? document.getElementById('playerPosition').value : null };
  fields.forEach(f => { const val = document.getElementById(`field_${f.key}`)?.value; if (val) stats[f.key] = val; });
  return stats;
}

function calculateRatings() {
  const stats = getStats();
  playerData = stats;
  const r = {}, isCareer = stats.season === 'career' || stats.season === 'Career', isPitcher = stats.type === 'pitcher', cfg = eraConfig[stats.era_type] || eraConfig.modern;
  const calcRate = (stat, ip) => hasCountStat(stat) && hasCountStat(ip) && num(ip) > 0 ? (num(stat) / num(ip)) * 9 : null;
  const getK9 = () => hasRateStat(stats.k_9) ? num(stats.k_9) : calcRate(stats.k, stats.ip);
  const getBB9 = () => hasRateStat(stats.bb_9) ? num(stats.bb_9) : calcRate(stats.bb, stats.ip);
  const getH9 = () => hasRateStat(stats.h_9) ? num(stats.h_9) : calcRate(stats.h, stats.ip);
  const getHR9 = () => hasRateStat(stats.hr_9) ? num(stats.hr_9) : calcRate(stats.hr, stats.ip);
  const getTBF = () => hasCountStat(stats.tbf) ? num(stats.tbf) : (hasCountStat(stats.ip) && hasCountStat(stats.h) && hasCountStat(stats.bb)) ? num(stats.h) + num(stats.bb) + (num(stats.ip) * 3) : null;
  const getKPct = () => hasRateStat(stats.k_pct) ? toPct(stats.k_pct) : (hasCountStat(stats.k) && getTBF()) ? (num(stats.k) / getTBF()) * 100 : null;
  const eraVeloRating = (k9) => Math.min(99, Math.max(25, Math.round(60 + (k9 - cfg.avgK9) * 8)));
  const eraBreakRating = (kPct) => Math.min(99, Math.max(25, Math.round(60 + (kPct - cfg.avgKPct) * 5)));

  if (isPitcher) {
    const k9 = getK9(), bb9 = getBB9(), h9 = getH9(), hr9 = getHR9(), kPct = getKPct();
    r.h_per_9 = h9 ? scale(h9, 5.5, 10.5, true) : hasRateStat(stats.era) ? scale(num(stats.era), 1.5, 5.5, true) : 70;
    r.k_per_9 = k9 ? scale(k9, 5.0, isCareer ? 10.5 : 13.0) : 70;
    r.bb_per_9 = bb9 ? scale(bb9, 1.0, 5.5, true) : hasRateStat(stats.whip) ? scale(Math.max(1.5, num(stats.whip) * 9 - 8.5), 1.0, 5.5, true) : 70;
    r.hr_per_9 = hr9 ? scale(hr9, 0.3, 1.8, true) : hasRateStat(stats.era) ? (num(stats.era) < 3 ? 95 : num(stats.era) < 4 ? 75 : num(stats.era) < 5 ? 55 : 40) : 70;
    r.pitching_clutch = hasRateStat(stats.era) ? scale(num(stats.era), 1.5, 5.5, true) : 70;
    r.control = r.bb_per_9 ? Math.round(r.bb_per_9 * 0.92) : 65;
    r.velocity = hasRateStat(stats.fb_velo) ? scale(num(stats.fb_velo), 88, 101) : (!isCareer && k9) ? eraVeloRating(k9) : 60;
    r.break_rating = hasRateStat(stats.whiff_pct) ? scale(toPct(stats.whiff_pct), 20, 40) : (!isCareer && kPct) ? eraBreakRating(kPct) : 60;
    r.stamina = hasCountStat(stats.ip) ? scale(num(stats.ip), isCareer ? 500 : 30, isCareer ? 3000 : cfg.staminaMax) : 80;
    r.fielding = 55; r.arm_strength = r.velocity ? Math.round(r.velocity * 0.85) : 70; r.arm_accuracy = 60; r.reaction = 50;
    r.durability = hasCountStat(stats.games) && hasCountStat(stats.ip) ? Math.round((scale(num(stats.games), isCareer ? 100 : 10, isCareer ? 1000 : 70) * 0.4 + scale(num(stats.ip), isCareer ? 500 : 30, isCareer ? 3000 : cfg.staminaMax) * 0.6)) : hasCountStat(stats.games) ? scale(num(stats.games), isCareer ? 100 : 10, isCareer ? 1000 : 70) : hasCountStat(stats.ip) ? scale(num(stats.ip), isCareer ? 500 : 30, isCareer ? 3000 : cfg.staminaMax) : 65;
    const core = [r.h_per_9, r.k_per_9, r.bb_per_9, r.hr_per_9, r.pitching_clutch, r.control, r.velocity, r.break_rating].map(v => Math.min(v || 70, 99));
    const avg = core.reduce((a, b) => a + b, 0) / 8;
    r.overall = Math.min(99, Math.max(25, Math.round(avg + cfg.spBase + Math.min((r.stamina || 50) * 0.163, 8))));
    r.overall_rp = Math.min(99, Math.max(25, Math.round(avg + cfg.rpBase)));
  } else {
    if (hasRateStat(stats.avg_vs_r)) r.contact_r = scale(num(stats.avg_vs_r), 0.200, 0.350);
    else if (hasRateStat(stats.avg)) { const base = scale(num(stats.avg), 0.200, 0.350); const kAdj = hasRateStat(stats.k_pct) && toPct(stats.k_pct) > 22 ? Math.round((toPct(stats.k_pct) - 22) * 0.8) : 0; r.contact_r = base ? Math.max(25, base - kAdj) : 70; } else r.contact_r = 70;
    r.contact_l = hasRateStat(stats.avg_vs_l) ? scale(num(stats.avg_vs_l), 0.200, 0.350) : Math.max(25, r.contact_r - 12);
    const getISO = () => hasRateStat(stats.iso) ? num(stats.iso) : (hasRateStat(stats.slg) && hasRateStat(stats.avg)) ? num(stats.slg) - num(stats.avg) : null;
    r.power_r = hasRateStat(stats.iso_vs_r) ? scale(num(stats.iso_vs_r), 0.080, 0.300) : getISO() ? scale(getISO(), 0.080, 0.300) : 70;
    r.power_l = hasRateStat(stats.iso_vs_l) ? scale(num(stats.iso_vs_l), 0.080, 0.300) : Math.max(25, r.power_r - 15);
    r.vision = hasRateStat(stats.k_pct) ? scale(toPct(stats.k_pct), 5, 30, true) : 70;
    r.discipline = hasRateStat(stats.bb_pct) ? scale(toPct(stats.bb_pct), 5, 18) : (hasRateStat(stats.obp) && hasRateStat(stats.avg)) ? scale(num(stats.obp) - num(stats.avg), 0.030, 0.100) : 70;
    r.clutch = 70;
    r.fielding = Math.min(99, hasFieldingStat(stats.oaa) ? scale(num(stats.oaa), -15, 15) : hasFieldingStat(stats.drs) ? scale(num(stats.drs), -15, 20) : hasRateStat(stats.fielding_pct) ? scale(num(stats.fielding_pct), 0.950, 1.000) : 65);
    r.speed = hasRateStat(stats.sprint_speed) ? scale(num(stats.sprint_speed), 23, 30) : hasCountStat(stats.sb) ? (isCareer ? Math.min(99, Math.max(25, Math.round(25 + Math.log(num(stats.sb) + 1) * 11))) : scale(num(stats.sb), 0, 50)) : 50;
    r.stealing = r.speed; r.baserunning = Math.round(r.speed * 0.9);
    r.arm_strength = Math.min(99, Math.round(r.fielding * 0.9 + 10));
    r.arm_accuracy = Math.min(99, Math.round(r.fielding * 0.85 + 10));
    r.reaction = Math.min(99, Math.round(r.fielding * 0.8 + 15));
    if (stats.position === 'C') r.blocking = (hasFieldingStat(stats.drs) || hasFieldingStat(stats.oaa)) ? Math.min(99, hasFieldingStat(stats.oaa) ? scale(num(stats.oaa), -15, 15) : scale(num(stats.drs), -15, 20)) : Math.min(99, Math.round((r.fielding + r.arm_strength + r.arm_accuracy + r.reaction) / 4));
    r.durability = hasCountStat(stats.games) ? scale(num(stats.games), isCareer ? 500 : 40, isCareer ? 3000 : 162) : 65;
    const posAdj = positionAdj[stats.position] || 0;
    const core = [r.contact_r, r.contact_l, r.power_r, r.power_l, r.vision, r.discipline, r.clutch, r.fielding, r.speed].map(v => Math.min(v || 70, 99));
    const coreAvg = core.reduce((a, b) => a + b, 0) / 9;
    r.overall = Math.min(99, Math.max(25, Math.round(coreAvg + 16 + posAdj - Math.max(0, (50 - coreAvg) * 1.9))));
  }
  ratings = r;
  displayResults();
}

function displayResults() {
  if (!ratings || !playerData) return;
  document.getElementById('resultsContainer').classList.remove('hidden');
  const tier = getTier(ratings.overall);
  document.getElementById('cardContainer').className = `player-card-wrapper ${tier.css}`;
  document.getElementById('resultName').textContent = playerData.name || 'Player';
  document.getElementById('resultMeta').textContent = `${playerData.season} ‚Ä¢ ${playerData.type}`;
  document.getElementById('resultOverall').textContent = Math.min(99, ratings.overall);
  document.getElementById('resultTier').innerHTML = `${tier.icon} ${tier.label}`;
  const rpDiv = document.getElementById('resultRP');
  if (playerData.type === 'pitcher') { rpDiv.textContent = `RP: ${ratings.overall_rp}`; rpDiv.classList.remove('hidden'); } else rpDiv.classList.add('hidden');
  const rc = document.getElementById('ratingsContainer');
  rc.innerHTML = playerData.type === 'pitcher' 
    ? `<div class="ratings-section"><h4>üéØ Pitching</h4>${ratingRow('H/9', ratings.h_per_9)}${ratingRow('K/9', ratings.k_per_9)}${ratingRow('BB/9', ratings.bb_per_9)}${ratingRow('HR/9', ratings.hr_per_9)}${ratingRow('Clutch', ratings.pitching_clutch)}${ratingRow('Control', ratings.control)}${ratingRow('Velocity', ratings.velocity)}${ratingRow('Break', ratings.break_rating)}${ratingRow('Stamina', ratings.stamina)}</div><div class="ratings-section"><h4>üõ°Ô∏è Fielding</h4>${ratingRow('Fielding', ratings.fielding)}${ratingRow('Arm Strength', ratings.arm_strength)}${ratingRow('Arm Accuracy', ratings.arm_accuracy)}${ratingRow('Reaction', ratings.reaction)}${ratingRow('Durability', ratings.durability)}</div>`
    : `<div class="ratings-section"><h4>üìà Hitting</h4>${ratingRow('Contact R', ratings.contact_r)}${ratingRow('Contact L', ratings.contact_l)}${ratingRow('Power R', ratings.power_r)}${ratingRow('Power L', ratings.power_l)}${ratingRow('Vision', ratings.vision)}${ratingRow('Discipline', ratings.discipline)}${ratingRow('Clutch', ratings.clutch)}</div><div class="ratings-section"><h4>‚ö° Speed</h4>${ratingRow('Speed', ratings.speed)}${ratingRow('Stealing', ratings.stealing)}${ratingRow('Baserunning', ratings.baserunning)}<h4 class="mt">üõ°Ô∏è Fielding</h4>${ratingRow('Fielding', ratings.fielding)}${ratingRow('Arm Strength', ratings.arm_strength)}${ratingRow('Arm Accuracy', ratings.arm_accuracy)}${ratingRow('Reaction', ratings.reaction)}${ratings.blocking ? ratingRow('Blocking', ratings.blocking) : ''}${ratingRow('Durability', ratings.durability)}</div>`;
  document.getElementById('rawStats').textContent = JSON.stringify(playerData, null, 2);
}

function ratingRow(label, value) { const v = Math.min(99, value || 0); return `<div class="rating-row"><span class="label">${label}</span><span class="value ${getRatingColor(v)}">${v}</span></div>`; }

function downloadCSV() {
  if (!ratings || !playerData) return;
  const rows = [['Attribute', 'Rating'], ...Object.entries(ratings).filter(([,v]) => v != null).map(([k, v]) => [k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()), Math.min(99, v)])];
  const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([rows.map(r => r.join(',')).join('\n')], { type: 'text/csv' }));
  a.download = `${(playerData.name || 'player').replace(/\s+/g, '_')}_ratings.csv`; a.click();
}

document.getElementById('playerType').addEventListener('change', buildFields);
document.getElementById('isCareer').addEventListener('change', function() { document.getElementById('season').disabled = this.checked; document.getElementById('season').classList.toggle('disabled', this.checked); });
buildFields();
</script>
</body>
</html>
