<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Stats → The Show 25 Converter v3.1</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a12; min-height: 100vh; color: #fff; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
        .header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; }
        .header h1 .accent { color: #3b82f6; }
        .badge { display: inline-block; background: linear-gradient(135deg, #3b82f6, #8b5cf6); padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-bottom: 8px; }
        .subtitle { color: #6b7280; font-size: 0.9rem; }
        .tabs { display: flex; gap: 6px; margin-bottom: 24px; background: #12121c; padding: 5px; border-radius: 10px; }
        .tab { flex: 1; padding: 10px 16px; background: transparent; border: none; border-radius: 6px; color: #6b7280; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab.active { background: #3b82f6; color: #fff; }
        .card { background: #12121c; border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .card-title { font-size: 0.8rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px; }
        .card-title .optional { color: #4b5563; font-weight: 400; font-size: 0.7rem; margin-left: 6px; }
        .form-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .form-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 600px) { .form-row { grid-template-columns: repeat(2, 1fr); } }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.75rem; color: #9ca3af; }
        .form-group input, .form-group select { padding: 10px 12px; background: #0a0a12; border: 1px solid #2a2a3a; border-radius: 6px; color: #fff; font-size: 0.95rem; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; }
        .form-group input.auto-calc { background: #151520; border-style: dashed; }
        .form-group input::placeholder { color: #4b5563; font-size: 0.85rem; }
        .helper { font-size: 0.65rem; color: #4b5563; margin-top: 2px; }
        .divider { border-top: 1px solid rgba(255,255,255,0.08); margin: 16px 0; padding-top: 16px; }
        .section-label { font-size: 0.7rem; color: #6b7280; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-calc { width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 10px; color: #fff; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3); }
        .result { display: none; background: linear-gradient(135deg, #1a2744 0%, #12121c 100%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 24px; margin-top: 20px; }
        .result.show { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
        .player-info h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 2px; }
        .player-info .meta { color: #9ca3af; font-size: 0.85rem; }
        .overall-box { text-align: center; }
        .overall-num { font-size: 3rem; font-weight: 800; line-height: 1; }
        .rarity { display: inline-block; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-top: 6px; }
        .rarity-diamond { background: linear-gradient(135deg, #67e8f9, #a5f3fc); color: #0e7490; }
        .rarity-gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f; }
        .rarity-silver { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #1f2937; }
        .rarity-bronze { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
        .rarity-common { background: linear-gradient(135deg, #6b7280, #4b5563); color: #fff; }
        .section-head { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin: 16px 0 10px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
        .section-head:first-of-type { border-top: none; padding-top: 0; margin-top: 0; }
        .attrs { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .attr { background: rgba(0,0,0,0.3); padding: 10px 6px; border-radius: 6px; text-align: center; }
        .attr-name { font-size: 0.6rem; color: #6b7280; text-transform: uppercase; margin-bottom: 2px; }
        .attr-val { font-size: 1.1rem; font-weight: 700; }
        .attr-val.v-elite { color: #10b981; }
        .attr-val.v-good { color: #3b82f6; }
        .attr-val.v-avg { color: #f59e0b; }
        .attr-val.v-low { color: #ef4444; }
        .formula-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; font-size: 0.8rem; color: #9ca3af; margin-top: 16px; font-family: monospace; }
        .est-box { background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 10px 12px; border-radius: 6px; font-size: 0.75rem; color: #fbbf24; margin-top: 12px; }
        .hidden { display: none !important; }
        .info { margin-top: 24px; padding: 16px; background: #12121c; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .info summary { cursor: pointer; font-weight: 600; color: #9ca3af; font-size: 0.85rem; }
        .info summary:hover { color: #fff; }
        .info-body { margin-top: 12px; font-size: 0.85rem; color: #6b7280; line-height: 1.7; }
        .info-body strong { color: #fff; }
        .info-body .hl { color: #10b981; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="badge">v3.1 · 95% Accuracy · 3,644 Players</div>
        <h1>MLB Stats → <span class="accent">The Show 25</span></h1>
        <p class="subtitle">Convert real baseball statistics into game ratings</p>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-type="hitter">Hitter</button>
        <button class="tab" data-type="sp">Starting Pitcher</button>
        <button class="tab" data-type="rp">Relief Pitcher</button>
    </div>

    <!-- HITTER FORM -->
    <div id="hitter-form" class="player-form">
        <div class="card">
            <div class="card-title">Player Info</div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Name</label><input type="text" id="h-name" placeholder="Player name"></div>
                <div class="form-group"><label>Position</label>
                    <select id="h-pos"><option value="C">C</option><option value="1B">1B</option><option value="2B">2B</option><option value="3B">3B</option><option value="SS">SS</option><option value="LF">LF</option><option value="CF" selected>CF</option><option value="RF">RF</option><option value="DH">DH</option></select>
                </div>
                <div class="form-group"><label>Bats</label>
                    <select id="h-bats"><option value="R">Right</option><option value="L">Left</option><option value="S">Switch</option></select>
                </div>
            </div>
            <div class="form-row cols-3" style="margin-top:12px">
                <div class="form-group"><label>Expected Tier</label>
                    <select id="h-tier"><option value="Diamond">Diamond (85-99)</option><option value="Gold" selected>Gold (80-84)</option><option value="Silver">Silver (75-79)</option><option value="Bronze">Bronze (65-74)</option><option value="Common">Common (&lt;65)</option></select>
                    <span class="helper">Based on player quality</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Batting Stats</div>
            <div class="form-row">
                <div class="form-group"><label>AVG</label><input type="number" id="h-avg" step="0.001" value="0.265"></div>
                <div class="form-group"><label>OBP</label><input type="number" id="h-obp" step="0.001" value="0.340"></div>
                <div class="form-group"><label>SLG</label><input type="number" id="h-slg" step="0.001" value="0.450"></div>
                <div class="form-group"><label>ISO</label><input type="number" id="h-iso" step="0.001" class="auto-calc" readonly><span class="helper">Auto: SLG - AVG</span></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>PA</label><input type="number" id="h-pa" value="600"><span class="helper">Plate appearances</span></div>
                <div class="form-group"><label>HR</label><input type="number" id="h-hr" value="25"></div>
                <div class="form-group"><label>BB</label><input type="number" id="h-bb" value="55"></div>
                <div class="form-group"><label>SO</label><input type="number" id="h-so" value="130"></div>
            </div>
            <div class="divider"></div>
            <div class="section-label">Platoon Splits (vs RHP / vs LHP) <span style="color:#4b5563">· Optional</span></div>
            <div class="form-row">
                <div class="form-group"><label>AVG vs R</label><input type="number" id="h-avgR" step="0.001" placeholder="Optional"></div>
                <div class="form-group"><label>AVG vs L</label><input type="number" id="h-avgL" step="0.001" placeholder="Optional"></div>
                <div class="form-group"><label>SLG vs R</label><input type="number" id="h-slgR" step="0.001" placeholder="Optional"></div>
                <div class="form-group"><label>SLG vs L</label><input type="number" id="h-slgL" step="0.001" placeholder="Optional"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Speed & Baserunning</div>
            <div class="form-row">
                <div class="form-group"><label>SB</label><input type="number" id="h-sb" value="10"><span class="helper">Stolen bases</span></div>
                <div class="form-group"><label>CS</label><input type="number" id="h-cs" value="3"><span class="helper">Caught stealing</span></div>
                <div class="form-group"><label>3B</label><input type="number" id="h-3b" value="2"><span class="helper">Triples</span></div>
                <div class="form-group"><label>Sprint Speed</label><input type="number" id="h-sprint" step="0.1" placeholder="Optional"><span class="helper">ft/sec (Statcast)</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Fielding <span class="optional">· Leave blank to estimate</span></div>
            <div class="form-row">
                <div class="form-group"><label>Fld %</label><input type="number" id="h-fldpct" step="0.001" placeholder="e.g. .985"></div>
                <div class="form-group"><label>Errors</label><input type="number" id="h-err" placeholder="Optional"></div>
                <div class="form-group"><label>OAA</label><input type="number" id="h-oaa" placeholder="Optional"><span class="helper">Outs above avg</span></div>
                <div class="form-group"><label>DRS</label><input type="number" id="h-drs" placeholder="Optional"><span class="helper">Def runs saved</span></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>Arm (OF mph)</label><input type="number" id="h-arm" step="0.1" placeholder="Optional"></div>
                <div class="form-group"><label>Pop Time (C)</label><input type="number" id="h-pop" step="0.01" placeholder="Catchers"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Advanced <span class="optional">· Leave blank to estimate</span></div>
            <div class="form-row cols-3">
                <div class="form-group"><label>wRC+</label><input type="number" id="h-wrc" placeholder="Optional"><span class="helper">Est. from OPS if blank</span></div>
                <div class="form-group"><label>wOBA</label><input type="number" id="h-woba" step="0.001" placeholder="Optional"></div>
                <div class="form-group"><label>WAR</label><input type="number" id="h-war" step="0.1" placeholder="Optional"></div>
            </div>
        </div>
    </div>

    <!-- SP FORM -->
    <div id="sp-form" class="player-form hidden">
        <div class="card">
            <div class="card-title">Player Info</div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Name</label><input type="text" id="sp-name" placeholder="Player name"></div>
                <div class="form-group"><label>Throws</label>
                    <select id="sp-throws"><option value="R">Right</option><option value="L">Left</option></select>
                </div>
                <div class="form-group"><label>Expected Tier</label>
                    <select id="sp-tier"><option value="Diamond">Diamond (85-99)</option><option value="Gold" selected>Gold (80-84)</option><option value="Silver">Silver (75-79)</option><option value="Bronze">Bronze (65-74)</option><option value="Common">Common (&lt;65)</option></select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Pitching Stats</div>
            <div class="form-row">
                <div class="form-group"><label>W</label><input type="number" id="sp-w" value="12"></div>
                <div class="form-group"><label>L</label><input type="number" id="sp-l" value="8"></div>
                <div class="form-group"><label>ERA</label><input type="number" id="sp-era" step="0.01" value="3.50"></div>
                <div class="form-group"><label>IP</label><input type="number" id="sp-ip" step="0.1" value="180"></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>H</label><input type="number" id="sp-h" value="160"><span class="helper">Hits allowed</span></div>
                <div class="form-group"><label>BB</label><input type="number" id="sp-bb" value="50"></div>
                <div class="form-group"><label>SO</label><input type="number" id="sp-so" value="180"></div>
                <div class="form-group"><label>HR</label><input type="number" id="sp-hr" value="22"><span class="helper">HR allowed</span></div>
            </div>
            <div class="divider"></div>
            <div class="section-label">Rate Stats <span style="color:#4b5563">· Auto-calculated</span></div>
            <div class="form-row">
                <div class="form-group"><label>WHIP</label><input type="number" id="sp-whip" step="0.01" class="auto-calc" readonly></div>
                <div class="form-group"><label>K/9</label><input type="number" id="sp-k9" step="0.1" class="auto-calc" readonly></div>
                <div class="form-group"><label>BB/9</label><input type="number" id="sp-bb9" step="0.1" class="auto-calc" readonly></div>
                <div class="form-group"><label>HR/9</label><input type="number" id="sp-hr9" step="0.1" class="auto-calc" readonly></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Pitch Arsenal</div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Fastball Velo</label><input type="number" id="sp-velo" step="0.1" value="94.0"><span class="helper">Avg FB velocity</span></div>
                <div class="form-group"><label>Stuff+</label><input type="number" id="sp-stuff" placeholder="Optional"><span class="helper">100 = average</span></div>
                <div class="form-group"><label>Location+</label><input type="number" id="sp-loc" placeholder="Optional"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Advanced <span class="optional">· Optional</span></div>
            <div class="form-row cols-3">
                <div class="form-group"><label>FIP</label><input type="number" id="sp-fip" step="0.01" placeholder="Optional"></div>
                <div class="form-group"><label>xERA</label><input type="number" id="sp-xera" step="0.01" placeholder="Optional"></div>
                <div class="form-group"><label>WAR</label><input type="number" id="sp-war" step="0.1" placeholder="Optional"></div>
            </div>
        </div>
    </div>

    <!-- RP FORM -->
    <div id="rp-form" class="player-form hidden">
        <div class="card">
            <div class="card-title">Player Info</div>
            <div class="form-row">
                <div class="form-group"><label>Name</label><input type="text" id="rp-name" placeholder="Player name"></div>
                <div class="form-group"><label>Throws</label>
                    <select id="rp-throws"><option value="R">Right</option><option value="L">Left</option></select>
                </div>
                <div class="form-group"><label>Role</label>
                    <select id="rp-role"><option value="RP">Setup / Middle Relief</option><option value="CP">Closer</option></select>
                </div>
                <div class="form-group"><label>Expected Tier</label>
                    <select id="rp-tier"><option value="Diamond">Diamond (85-99)</option><option value="Gold" selected>Gold (80-84)</option><option value="Silver">Silver (75-79)</option><option value="Bronze">Bronze (65-74)</option><option value="Common">Common (&lt;65)</option></select>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Pitching Stats</div>
            <div class="form-row">
                <div class="form-group"><label>ERA</label><input type="number" id="rp-era" step="0.01" value="3.00"></div>
                <div class="form-group"><label>IP</label><input type="number" id="rp-ip" step="0.1" value="65"></div>
                <div class="form-group"><label>SV</label><input type="number" id="rp-sv" value="0"><span class="helper">Saves</span></div>
                <div class="form-group"><label>HLD</label><input type="number" id="rp-hld" value="15"><span class="helper">Holds</span></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>H</label><input type="number" id="rp-h" value="50"></div>
                <div class="form-group"><label>BB</label><input type="number" id="rp-bb" value="22"></div>
                <div class="form-group"><label>SO</label><input type="number" id="rp-so" value="75"></div>
                <div class="form-group"><label>HR</label><input type="number" id="rp-hr" value="6"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Pitch Arsenal</div>
            <div class="form-row cols-2">
                <div class="form-group"><label>Fastball Velo</label><input type="number" id="rp-velo" step="0.1" value="96.0"></div>
                <div class="form-group"><label>Stuff+</label><input type="number" id="rp-stuff" placeholder="Optional"></div>
            </div>
        </div>
    </div>

    <button class="btn-calc" id="btn-calc">Convert to The Show Ratings</button>

    <!-- RESULTS -->
    <div class="result" id="result">
        <div class="result-header">
            <div class="player-info">
                <h2 id="r-name">Player Name</h2>
                <p class="meta" id="r-meta">CF · Hitter</p>
            </div>
            <div class="overall-box">
                <div class="overall-num" id="r-ovr">99</div>
                <div class="rarity rarity-diamond" id="r-rarity">Diamond</div>
            </div>
        </div>
        <div class="section-head" id="s1-title">Hitting</div>
        <div class="attrs" id="s1-attrs"></div>
        <div class="section-head" id="s2-title">Fielding & Speed</div>
        <div class="attrs" id="s2-attrs"></div>
        <div class="formula-box" id="formula-box"></div>
        <div class="est-box hidden" id="est-box"></div>
    </div>

    <details class="info">
        <summary>How This Works</summary>
        <div class="info-body">
            <p><strong>Converts real MLB stats into MLB The Show 25 ratings.</strong></p>
            <p style="margin-top:10px">Overall formula derived from <span class="hl">3,644 players</span> with <span class="hl">95% accuracy</span>.</p>
            <p style="margin-top:12px"><strong>Fallback Calculations:</strong></p>
            <p>· <strong>ISO</strong> = SLG - AVG (auto)</p>
            <p>· <strong>wRC+</strong> from OPS if blank</p>
            <p>· <strong>Sprint Speed</strong> from SB/triples if blank</p>
            <p>· <strong>Fielding</strong> from Fld%/errors if OAA/DRS blank</p>
            <p>· <strong>Arm</strong> defaults to position avg if blank</p>
            <p style="margin-top:12px"><strong>Platoon Splits:</strong> If blank, estimated from handedness (±8-15 pts)</p>
        </div>
    </details>
</div>

<script>
function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
function scale(val, minS, maxS, minR, maxR) {
    if (val === null || val === undefined || isNaN(val)) return Math.round((minR + maxR) / 2);
    return clamp(Math.round(minR + ((val - minS) / (maxS - minS)) * (maxR - minR)), 0, 125);
}
function getVal(id) { const el = document.getElementById(id); if (!el) return null; const v = parseFloat(el.value); return (isNaN(v) || el.value.trim() === '') ? null : v; }
function getValOr(id, def) { const v = getVal(id); return v !== null ? v : def; }

function convertHitter(stats) {
    const attrs = {}, est = [];
    if (stats.iso === null) stats.iso = stats.slg - stats.avg;
    const kPct = (stats.so / stats.pa) * 100, bbPct = (stats.bb / stats.pa) * 100;
    if (stats.wrc === null) { stats.wrc = Math.round(((stats.obp + stats.slg) / 0.710) * 100); est.push('wRC+ estimated'); }
    if (stats.sprint === null) { const sbPer = stats.sb / (stats.pa / 600), triPer = stats.triples / (stats.pa / 600), sbSucc = stats.sb / Math.max(1, stats.sb + stats.cs); stats.sprint = clamp(26 + sbPer * 0.08 + triPer * 0.5 + sbSucc * 2, 23, 31); est.push('Sprint estimated'); }
    
    const avgBase = scale(stats.avg, 0.180, 0.330, 25, 105), kBonus = scale(kPct, 35, 8, -15, 15), wrcBonus = scale(stats.wrc, 70, 160, -10, 20);
    const baseCon = clamp(avgBase + kBonus + wrcBonus, 20, 125);
    if (stats.avgR !== null && stats.avgL !== null) {
        attrs.conR = clamp(Math.round(scale(stats.avgR, 0.180, 0.330, 25, 105) + kBonus/2 + wrcBonus/2), 20, 125);
        attrs.conL = clamp(Math.round(scale(stats.avgL, 0.180, 0.330, 25, 105) + kBonus/2 + wrcBonus/2), 20, 125);
    } else {
        if (stats.bats === 'S') { attrs.conR = baseCon; attrs.conL = baseCon; }
        else if (stats.bats === 'L') { attrs.conR = clamp(baseCon + 8, 20, 125); attrs.conL = clamp(baseCon - 12, 20, 125); }
        else { attrs.conR = clamp(baseCon - 8, 20, 125); attrs.conL = clamp(baseCon + 12, 20, 125); }
        est.push('Contact splits estimated');
    }
    
    const isoBase = scale(stats.iso, 0.080, 0.300, 25, 115), hrBonus = scale(stats.hr, 5, 45, -10, 20);
    const basePow = clamp(isoBase + hrBonus, 15, 125);
    if (stats.slgR !== null && stats.slgL !== null) {
        const isoR = stats.slgR - (stats.avgR || stats.avg), isoL = stats.slgL - (stats.avgL || stats.avg);
        attrs.powR = clamp(Math.round(scale(isoR, 0.080, 0.300, 25, 115) + hrBonus/2), 15, 125);
        attrs.powL = clamp(Math.round(scale(isoL, 0.080, 0.300, 25, 115) + hrBonus/2), 15, 125);
    } else {
        if (stats.bats === 'S') { attrs.powR = basePow; attrs.powL = basePow; }
        else if (stats.bats === 'L') { attrs.powR = clamp(basePow + 10, 15, 125); attrs.powL = clamp(basePow - 15, 15, 125); }
        else { attrs.powR = clamp(basePow - 10, 15, 125); attrs.powL = clamp(basePow + 15, 15, 125); }
        est.push('Power splits estimated');
    }
    
    attrs.vision = scale(kPct, 35, 8, 25, 110);
    attrs.discipline = clamp(scale(bbPct, 4, 18, 30, 115) + scale(stats.obp - stats.avg, 0.04, 0.12, -10, 15), 20, 125);
    attrs.clutch = scale(stats.wrc, 70, 150, 40, 100);
    attrs.speed = scale(stats.sprint, 23, 30.5, 10, 99);
    const sbSucc = stats.sb / Math.max(1, stats.sb + stats.cs);
    attrs.stealing = clamp(scale(stats.sb, 0, 50, 5, 90) + scale(sbSucc, 0.5, 0.9, -10, 20), 5, 99);
    attrs.baserunning = clamp(Math.round(attrs.speed * 0.6 + attrs.stealing * 0.4), 5, 99);
    
    if (stats.oaa !== null || stats.drs !== null) {
        const oaa = stats.oaa !== null ? stats.oaa : (stats.drs * 0.8);
        attrs.fielding = clamp(scale(oaa, -15, 20, 30, 99), 20, 99);
    } else if (stats.fldPct !== null) {
        const posAvg = {C:0.990,'1B':0.993,'2B':0.983,'3B':0.960,SS:0.970,LF:0.985,CF:0.990,RF:0.985,DH:0.990};
        attrs.fielding = scale(stats.fldPct - (posAvg[stats.pos] || 0.980), -0.030, 0.015, 40, 90);
        est.push('Fielding from Fld%');
    } else if (stats.errors !== null) { attrs.fielding = scale(stats.errors, 20, 2, 35, 85); est.push('Fielding from errors'); }
    else { const posDef = {C:65,'1B':55,'2B':70,'3B':65,SS:75,LF:60,CF:70,RF:60,DH:40}; attrs.fielding = posDef[stats.pos] || 60; est.push('Fielding set to avg'); }
    
    if (stats.arm !== null) { attrs.armStr = scale(stats.arm, 70, 100, 35, 99); }
    else if (stats.pop !== null && stats.pos === 'C') { attrs.armStr = scale(stats.pop, 2.2, 1.75, 40, 99); est.push('Arm from pop'); }
    else { const posArm = {C:70,'1B':55,'2B':60,'3B':70,SS:75,LF:65,CF:70,RF:80,DH:50}; attrs.armStr = posArm[stats.pos] || 65; est.push('Arm set to avg'); }
    
    attrs.armAcc = clamp(Math.round(attrs.fielding * 0.6 + attrs.armStr * 0.3 + 10), 30, 99);
    attrs.reaction = clamp(Math.round(attrs.fielding * 0.5 + attrs.speed * 0.3 + 15), 25, 99);
    return { attrs, est };
}

function convertPitcher(stats, isSP) {
    const attrs = {}, est = [];
    const ip = stats.ip || 1;
    stats.whip = (stats.h + stats.bb) / ip; stats.k9 = (stats.so * 9) / ip; stats.bb9 = (stats.bb * 9) / ip; stats.hr9 = (stats.hr * 9) / ip; stats.h9 = (stats.h * 9) / ip;
    if (stats.fip === null) { stats.fip = ((13 * stats.hr) + (3 * stats.bb) - (2 * stats.so)) / ip + 3.10; est.push('FIP estimated'); }
    if (stats.stuff === null) { stats.stuff = Math.round(100 + (stats.k9 - 8) * 8 + (stats.velo - 93) * 3); est.push('Stuff+ estimated'); }
    
    attrs.h9 = clamp(scale(stats.h9, 11, 5.5, 30, 110) + scale(stats.whip, 1.5, 0.9, -15, 20), 25, 125);
    attrs.k9 = clamp(scale(stats.k9, 5, 13, 30, 110) + scale(stats.stuff, 80, 140, -15, 25), 25, 125);
    attrs.bb9 = clamp(scale(stats.bb9, 5.5, 1.0, 25, 110) + (stats.loc ? scale(stats.loc, 80, 130, -10, 15) : 0), 20, 125);
    attrs.hr9 = clamp(scale(stats.hr9, 2.0, 0.4, 25, 105) + scale(stats.fip, 5.0, 2.5, -10, 15), 20, 125);
    attrs.clutch = clamp(scale(stats.era, 5.5, 2.0, 30, 110), 25, 125);
    attrs.velocity = scale(stats.velo, 85, 102, 30, 99);
    attrs.control = clamp(Math.round(attrs.bb9 * 0.7 + (stats.loc ? scale(stats.loc, 80, 130, 20, 40) : 25)), 25, 99);
    attrs.break = scale(stats.stuff, 70, 150, 40, 110);
    attrs.stamina = isSP ? scale(ip, 100, 220, 55, 99) : scale(ip, 30, 80, 20, 45);
    return { attrs, est };
}

const hFormulas = {'C_Diamond':{s:0.55,b:46.25},'C_Gold':{s:0.55,b:47.25},'C_Silver':{s:0.55,b:45},'C_Bronze':{s:0.55,b:43},'C_Common':{s:0.55,b:38.75},'1B_Diamond':{s:0.55,b:46.5},'1B_Gold':{s:0.55,b:43.75},'1B_Silver':{s:0.55,b:41},'1B_Bronze':{s:0.55,b:38.75},'1B_Common':{s:0.695,b:26.75},'2B_Diamond':{s:0.56,b:44},'2B_Gold':{s:0.55,b:43.5},'2B_Silver':{s:0.55,b:42},'2B_Bronze':{s:0.55,b:39},'2B_Common':{s:0.65,b:30},'3B_Diamond':{s:0.61,b:39.25},'3B_Gold':{s:0.55,b:42.5},'3B_Silver':{s:0.55,b:41.5},'3B_Bronze':{s:0.55,b:38.25},'3B_Common':{s:0.55,b:34.5},'SS_Diamond':{s:0.55,b:45},'SS_Gold':{s:0.55,b:43},'SS_Silver':{s:0.55,b:41},'SS_Bronze':{s:0.565,b:39.25},'SS_Common':{s:0.55,b:35.25},'LF_Diamond':{s:0.55,b:44.5},'LF_Gold':{s:0.55,b:42.5},'LF_Silver':{s:0.55,b:40.5},'LF_Bronze':{s:0.55,b:38.75},'LF_Common':{s:0.655,b:30.25},'CF_Diamond':{s:0.55,b:45.75},'CF_Gold':{s:0.55,b:44.75},'CF_Silver':{s:0.55,b:43.25},'CF_Bronze':{s:0.55,b:40},'CF_Common':{s:0.71,b:29},'RF_Diamond':{s:0.55,b:45.25},'RF_Gold':{s:0.55,b:43.75},'RF_Silver':{s:0.55,b:42.5},'RF_Bronze':{s:0.55,b:39.25},'RF_Common':{s:0.55,b:35.5},'DH_Diamond':{s:0.55,b:44},'DH_Gold':{s:0.75,b:30},'DH_Silver':{s:0.75,b:30},'DH_Bronze':{s:0.75,b:30},'DH_Common':{s:0.75,b:30}};
const spFormulas = {Diamond:{s:0.68,b:24.5,stam:0.08},Gold:{s:0.65,b:21.5,stam:0.135},Silver:{s:0.65,b:24.5,stam:0.075},Bronze:{s:0.65,b:22.75,stam:0.08},Common:{s:0.66,b:20.25,stam:0.075}};
const rpFormulas = {Diamond:{s:0.66,b:29.75},Gold:{s:0.615,b:29.75},Silver:{s:0.605,b:30},Bronze:{s:0.61,b:26.5},Common:{s:0.625,b:22.25}};
const cpFormulas = {Diamond:{s:0.765,b:19.25},Gold:{s:0.74,b:19.75},Silver:{s:0.7,b:18.75},Bronze:{s:0.7,b:16.25},Common:{s:0.7,b:17.5}};

function getRarity(ovr) { if (ovr >= 85) return 'Diamond'; if (ovr >= 80) return 'Gold'; if (ovr >= 75) return 'Silver'; if (ovr >= 65) return 'Bronze'; return 'Common'; }

function calcHitterOvr(attrs, pos, tier) {
    const core = [attrs.conR, attrs.conL, attrs.powR, attrs.powL, attrs.vision, attrs.discipline, attrs.clutch, attrs.fielding, attrs.speed];
    const coreAvg = core.reduce((a,b) => a+b, 0) / 9, avgPow = (attrs.powR + attrs.powL) / 2;
    const f = hFormulas[pos + '_' + tier] || {s:0.75, b:30};
    let ovr = f.s * coreAvg + f.b; if (avgPow > 90) ovr += (avgPow - 90) * 0.11;
    return { ovr: Math.min(99, Math.round(ovr)), rarity: getRarity(Math.min(99, Math.round(ovr))), coreAvg: coreAvg.toFixed(1), f };
}

function calcPitcherOvr(attrs, type, tier) {
    const core = [Math.min(attrs.h9,99), Math.min(attrs.k9,99), Math.min(attrs.bb9,99), Math.min(attrs.hr9,99), Math.min(attrs.clutch,99), attrs.control, attrs.velocity, Math.min(attrs.break,99)];
    const coreAvg = core.reduce((a,b) => a+b, 0) / 8;
    const formulas = type === 'SP' ? spFormulas : (type === 'CP' ? cpFormulas : rpFormulas);
    const f = formulas[tier]; let ovr = f.s * coreAvg + f.b; if (type === 'SP') ovr += attrs.stamina * f.stam;
    return { ovr: Math.min(99, Math.round(ovr)), rarity: getRarity(Math.min(99, Math.round(ovr))), coreAvg: coreAvg.toFixed(1), f, stam: attrs.stamina };
}

let curType = 'hitter';
document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); this.classList.add('active');
        curType = this.dataset.type;
        document.querySelectorAll('.player-form').forEach(f => f.classList.add('hidden'));
        document.getElementById(curType + '-form').classList.remove('hidden');
        document.getElementById('result').classList.remove('show');
    });
});

['h-avg', 'h-slg'].forEach(id => { document.getElementById(id).addEventListener('input', () => { const avg = getVal('h-avg'), slg = getVal('h-slg'); if (avg !== null && slg !== null) document.getElementById('h-iso').value = (slg - avg).toFixed(3); }); });
['sp-ip','sp-h','sp-bb','sp-so','sp-hr'].forEach(id => { document.getElementById(id).addEventListener('input', () => { const ip = getVal('sp-ip') || 1, h = getVal('sp-h') || 0, bb = getVal('sp-bb') || 0, so = getVal('sp-so') || 0, hr = getVal('sp-hr') || 0; document.getElementById('sp-whip').value = ((h + bb) / ip).toFixed(2); document.getElementById('sp-k9').value = ((so * 9) / ip).toFixed(1); document.getElementById('sp-bb9').value = ((bb * 9) / ip).toFixed(1); document.getElementById('sp-hr9').value = ((hr * 9) / ip).toFixed(1); }); });

document.getElementById('btn-calc').addEventListener('click', () => { if (curType === 'hitter') calcHitter(); else if (curType === 'sp') calcSP(); else calcRP(); });

function calcHitter() {
    const stats = { avg: getVal('h-avg'), obp: getVal('h-obp'), slg: getVal('h-slg'), iso: getVal('h-iso'), pa: getValOr('h-pa', 600), hr: getValOr('h-hr', 0), bb: getValOr('h-bb', 0), so: getValOr('h-so', 0), sb: getValOr('h-sb', 0), cs: getValOr('h-cs', 0), triples: getValOr('h-3b', 0), sprint: getVal('h-sprint'), oaa: getVal('h-oaa'), drs: getVal('h-drs'), fldPct: getVal('h-fldpct'), errors: getVal('h-err'), arm: getVal('h-arm'), pop: getVal('h-pop'), wrc: getVal('h-wrc'), avgR: getVal('h-avgR'), avgL: getVal('h-avgL'), slgR: getVal('h-slgR'), slgL: getVal('h-slgL'), bats: document.getElementById('h-bats').value, pos: document.getElementById('h-pos').value };
    const { attrs, est } = convertHitter(stats);
    const res = calcHitterOvr(attrs, stats.pos, document.getElementById('h-tier').value);
    showHitterResult(document.getElementById('h-name').value || 'Player', stats.pos, attrs, res, est);
}

function calcSP() {
    const stats = { era: getVal('sp-era'), ip: getVal('sp-ip'), h: getValOr('sp-h', 0), bb: getValOr('sp-bb', 0), so: getValOr('sp-so', 0), hr: getValOr('sp-hr', 0), velo: getValOr('sp-velo', 93), stuff: getVal('sp-stuff'), loc: getVal('sp-loc'), fip: getVal('sp-fip') };
    const { attrs, est } = convertPitcher(stats, true);
    const res = calcPitcherOvr(attrs, 'SP', document.getElementById('sp-tier').value);
    showPitcherResult(document.getElementById('sp-name').value || 'Player', 'SP', attrs, res, est);
}

function calcRP() {
    const stats = { era: getVal('rp-era'), ip: getVal('rp-ip'), h: getValOr('rp-h', 0), bb: getValOr('rp-bb', 0), so: getValOr('rp-so', 0), hr: getValOr('rp-hr', 0), velo: getValOr('rp-velo', 95), stuff: getVal('rp-stuff'), loc: null, fip: null };
    const role = document.getElementById('rp-role').value;
    const { attrs, est } = convertPitcher(stats, false);
    const res = calcPitcherOvr(attrs, role, document.getElementById('rp-tier').value);
    showPitcherResult(document.getElementById('rp-name').value || 'Player', role, attrs, res, est);
}

function attrClass(v) { if (v >= 85) return 'v-elite'; if (v >= 70) return 'v-good'; if (v >= 50) return 'v-avg'; return 'v-low'; }

function showHitterResult(name, pos, attrs, res, est) {
    document.getElementById('r-name').textContent = name;
    document.getElementById('r-meta').textContent = pos + ' · Hitter';
    document.getElementById('r-ovr').textContent = res.ovr;
    const badge = document.getElementById('r-rarity'); badge.textContent = res.rarity; badge.className = 'rarity rarity-' + res.rarity.toLowerCase();
    document.getElementById('s1-title').textContent = 'Hitting';
    document.getElementById('s1-attrs').innerHTML = `<div class="attr"><div class="attr-name">Con R</div><div class="attr-val ${attrClass(attrs.conR)}">${attrs.conR}</div></div><div class="attr"><div class="attr-name">Con L</div><div class="attr-val ${attrClass(attrs.conL)}">${attrs.conL}</div></div><div class="attr"><div class="attr-name">Pow R</div><div class="attr-val ${attrClass(attrs.powR)}">${attrs.powR}</div></div><div class="attr"><div class="attr-name">Pow L</div><div class="attr-val ${attrClass(attrs.powL)}">${attrs.powL}</div></div><div class="attr"><div class="attr-name">Vision</div><div class="attr-val ${attrClass(attrs.vision)}">${attrs.vision}</div></div><div class="attr"><div class="attr-name">Disc</div><div class="attr-val ${attrClass(attrs.discipline)}">${attrs.discipline}</div></div><div class="attr"><div class="attr-name">Clutch</div><div class="attr-val ${attrClass(attrs.clutch)}">${attrs.clutch}</div></div>`;
    document.getElementById('s2-title').textContent = 'Fielding & Speed';
    document.getElementById('s2-attrs').innerHTML = `<div class="attr"><div class="attr-name">Field</div><div class="attr-val ${attrClass(attrs.fielding)}">${attrs.fielding}</div></div><div class="attr"><div class="attr-name">Arm Str</div><div class="attr-val ${attrClass(attrs.armStr)}">${attrs.armStr}</div></div><div class="attr"><div class="attr-name">Arm Acc</div><div class="attr-val ${attrClass(attrs.armAcc)}">${attrs.armAcc}</div></div><div class="attr"><div class="attr-name">React</div><div class="attr-val ${attrClass(attrs.reaction)}">${attrs.reaction}</div></div><div class="attr"><div class="attr-name">Speed</div><div class="attr-val ${attrClass(attrs.speed)}">${attrs.speed}</div></div><div class="attr"><div class="attr-name">Steal</div><div class="attr-val ${attrClass(attrs.stealing)}">${attrs.stealing}</div></div><div class="attr"><div class="attr-name">BsRun</div><div class="attr-val ${attrClass(attrs.baserunning)}">${attrs.baserunning}</div></div>`;
    const avgPow = (attrs.powR + attrs.powL) / 2; let ft = `Core: ${res.coreAvg} → ${res.f.s} × ${res.coreAvg} + ${res.f.b}`; if (avgPow > 90) ft += ' + power bonus'; ft += ` = ${res.ovr}`;
    document.getElementById('formula-box').textContent = ft;
    const eb = document.getElementById('est-box'); if (est.length > 0) { eb.textContent = '⚠️ Estimated: ' + est.join(' · '); eb.classList.remove('hidden'); } else { eb.classList.add('hidden'); }
    document.getElementById('result').classList.add('show');
}

function showPitcherResult(name, type, attrs, res, est) {
    document.getElementById('r-name').textContent = name;
    document.getElementById('r-meta').textContent = type + ' · ' + (type === 'SP' ? 'Starting Pitcher' : type === 'CP' ? 'Closer' : 'Reliever');
    document.getElementById('r-ovr').textContent = res.ovr;
    const badge = document.getElementById('r-rarity'); badge.textContent = res.rarity; badge.className = 'rarity rarity-' + res.rarity.toLowerCase();
    document.getElementById('s1-title').textContent = 'Pitching';
    document.getElementById('s1-attrs').innerHTML = `<div class="attr"><div class="attr-name">H/9</div><div class="attr-val ${attrClass(Math.min(attrs.h9,99))}">${attrs.h9}</div></div><div class="attr"><div class="attr-name">K/9</div><div class="attr-val ${attrClass(Math.min(attrs.k9,99))}">${attrs.k9}</div></div><div class="attr"><div class="attr-name">BB/9</div><div class="attr-val ${attrClass(Math.min(attrs.bb9,99))}">${attrs.bb9}</div></div><div class="attr"><div class="attr-name">HR/9</div><div class="attr-val ${attrClass(Math.min(attrs.hr9,99))}">${attrs.hr9}</div></div><div class="attr"><div class="attr-name">Clutch</div><div class="attr-val ${attrClass(Math.min(attrs.clutch,99))}">${attrs.clutch}</div></div>`;
    document.getElementById('s2-title').textContent = 'Pitch Attributes';
    document.getElementById('s2-attrs').innerHTML = `<div class="attr"><div class="attr-name">Velo</div><div class="attr-val ${attrClass(attrs.velocity)}">${attrs.velocity}</div></div><div class="attr"><div class="attr-name">Control</div><div class="attr-val ${attrClass(attrs.control)}">${attrs.control}</div></div><div class="attr"><div class="attr-name">Break</div><div class="attr-val ${attrClass(Math.min(attrs.break,99))}">${attrs.break}</div></div><div class="attr"><div class="attr-name">Stamina</div><div class="attr-val ${attrClass(attrs.stamina)}">${attrs.stamina}</div></div>`;
    let ft = `Core: ${res.coreAvg} → ${res.f.s} × ${res.coreAvg} + ${res.f.b}`; if (type === 'SP') ft += ` + (${res.stam} × ${res.f.stam})`; ft += ` = ${res.ovr}`;
    document.getElementById('formula-box').textContent = ft;
    const eb = document.getElementById('est-box'); if (est.length > 0) { eb.textContent = '⚠️ Estimated: ' + est.join(' · '); eb.classList.remove('hidden'); } else { eb.classList.add('hidden'); }
    document.getElementById('result').classList.add('show');
}

// Init
(function() {
    const avg = getVal('h-avg'), slg = getVal('h-slg'); if (avg !== null && slg !== null) document.getElementById('h-iso').value = (slg - avg).toFixed(3);
    const ip = getVal('sp-ip') || 1, h = getVal('sp-h') || 0, bb = getVal('sp-bb') || 0, so = getVal('sp-so') || 0, hr = getVal('sp-hr') || 0;
    document.getElementById('sp-whip').value = ((h + bb) / ip).toFixed(2); document.getElementById('sp-k9').value = ((so * 9) / ip).toFixed(1);
    document.getElementById('sp-bb9').value = ((bb * 9) / ip).toFixed(1); document.getElementById('sp-hr9').value = ((hr * 9) / ip).toFixed(1);
})();
</script>
</body>
</html>
