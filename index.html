<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Stats ‚Üí The Show 25 Converter v4.0</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a12; min-height: 100vh; color: #fff; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
        .header { text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 8px; }
        .header h1 .accent { color: #3b82f6; }
        .badges { margin-bottom: 8px; }
        .badge { display: inline-block; background: linear-gradient(135deg, #3b82f6, #8b5cf6); padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin: 2px; }
        .badge.new { background: linear-gradient(135deg, #10b981, #059669); }
        .subtitle { color: #6b7280; font-size: 0.9rem; }
        .tabs { display: flex; gap: 6px; margin-bottom: 24px; background: #12121c; padding: 5px; border-radius: 10px; flex-wrap: wrap; }
        .tab { flex: 1; padding: 10px 12px; background: transparent; border: none; border-radius: 6px; color: #6b7280; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s; min-width: 70px; }
        .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab.active { background: #3b82f6; color: #fff; }
        .tab.search-tab.active { background: linear-gradient(135deg, #10b981, #059669); }
        .card { background: #12121c; border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .card-title { font-size: 0.8rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px; }
        .form-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .form-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
        .form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
        @media (max-width: 600px) { .form-row { grid-template-columns: repeat(2, 1fr); } }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 0.75rem; color: #9ca3af; }
        .form-group input, .form-group select { padding: 10px 12px; background: #0a0a12; border: 1px solid #2a2a3a; border-radius: 6px; color: #fff; font-size: 0.95rem; width: 100%; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; }
        .form-group input.auto-calc { background: #151520; border-style: dashed; }
        .form-group input::placeholder { color: #4b5563; font-size: 0.85rem; }
        .helper { font-size: 0.65rem; color: #4b5563; margin-top: 2px; }
        .btn-calc { width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 10px; color: #fff; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3); }
        .btn-calc:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-search { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-search:hover { box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3); }
        .result { display: none; background: linear-gradient(135deg, #1a2744 0%, #12121c 100%); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 24px; margin-top: 20px; }
        .result.show { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 16px; }
        .player-info h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 2px; }
        .player-info .meta { color: #9ca3af; font-size: 0.85rem; }
        .overall-box { text-align: center; }
        .overall-num { font-size: 3rem; font-weight: 800; line-height: 1; }
        .rarity { display: inline-block; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-top: 6px; }
        .rarity-diamond { background: linear-gradient(135deg, #67e8f9, #a5f3fc); color: #0e7490; }
        .rarity-gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f; }
        .rarity-silver { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #1f2937; }
        .rarity-bronze { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
        .rarity-common { background: linear-gradient(135deg, #6b7280, #4b5563); color: #fff; }
        .section-head { font-size: 0.75rem; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin: 16px 0 10px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
        .section-head:first-of-type { border-top: none; padding-top: 0; margin-top: 0; }
        .attrs { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .attr { background: rgba(0,0,0,0.3); padding: 10px 6px; border-radius: 6px; text-align: center; }
        .attr-name { font-size: 0.6rem; color: #6b7280; text-transform: uppercase; margin-bottom: 2px; }
        .attr-val { font-size: 1.1rem; font-weight: 700; }
        .attr-val.v-elite { color: #10b981; }
        .attr-val.v-good { color: #3b82f6; }
        .attr-val.v-avg { color: #f59e0b; }
        .attr-val.v-low { color: #ef4444; }
        .formula-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; font-size: 0.8rem; color: #9ca3af; margin-top: 16px; font-family: monospace; }
        .est-box { background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 10px 12px; border-radius: 6px; font-size: 0.75rem; color: #fbbf24; margin-top: 12px; }
        .real-stats-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px; border-radius: 6px; font-size: 0.85rem; color: #93c5fd; margin-top: 12px; }
        .hidden { display: none !important; }
        .search-box { position: relative; }
        .search-input { padding: 14px 16px !important; font-size: 1.1rem !important; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #1a1a2e; border: 1px solid #2a2a3a; border-radius: 8px; margin-top: 4px; max-height: 300px; overflow-y: auto; z-index: 100; display: none; }
        .search-results.show { display: block; }
        .search-result { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .search-result:hover { background: rgba(59, 130, 246, 0.1); }
        .search-result .name { font-weight: 600; }
        .search-result .years { color: #6b7280; font-size: 0.85rem; margin-left: 8px; }
        .db-status { text-align: center; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; margin-bottom: 16px; font-size: 0.85rem; color: #10b981; }
        .db-status.error { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444; }
        .db-status.loading { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: #3b82f6; }
        .info { margin-top: 24px; padding: 16px; background: #12121c; border-radius: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .info summary { cursor: pointer; font-weight: 600; color: #9ca3af; font-size: 0.85rem; }
        .info-body { margin-top: 12px; font-size: 0.85rem; color: #6b7280; line-height: 1.7; }
        .info-body strong { color: #fff; }
        .info-body .hl { color: #10b981; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="badges">
            <span class="badge">v4.0 ¬∑ 95% Accuracy</span>
            <span class="badge new">üîç Lahman DB: 24,270 Players</span>
        </div>
        <h1>MLB Stats ‚Üí <span class="accent">The Show 25</span></h1>
        <p class="subtitle">Convert real baseball statistics into game ratings</p>
    </div>
    
    <div class="tabs">
        <button class="tab search-tab active" data-type="search">üîç Search</button>
        <button class="tab" data-type="hitter">Hitter</button>
        <button class="tab" data-type="sp">SP</button>
        <button class="tab" data-type="rp">RP</button>
    </div>

    <div id="search-form" class="player-form">
        <div id="db-status" class="db-status loading">üìä Loading Lahman Database (may take a moment)...</div>
        <div class="card">
            <div class="card-title">Search Historical Players (1871-2024)</div>
            <div class="form-row cols-3">
                <div class="form-group" style="grid-column: span 2;">
                    <label>Player Name</label>
                    <div class="search-box">
                        <input type="text" id="search-name" class="search-input" placeholder="e.g. Babe Ruth, Willie Mays..." autocomplete="off">
                        <div id="search-results" class="search-results"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <input type="number" id="search-year" placeholder="e.g. 1954" min="1871" max="2024">
                </div>
            </div>
            <div class="form-row cols-3" style="margin-top: 12px;">
                <div class="form-group"><label>Tier Override</label><select id="search-tier"><option value="">Auto</option><option value="Diamond">Diamond</option><option value="Gold">Gold</option><option value="Silver">Silver</option><option value="Bronze">Bronze</option><option value="Common">Common</option></select></div>
                <div class="form-group"><label>Velo Override (P)</label><input type="number" id="search-velo" placeholder="Auto" step="0.1"></div>
                <div class="form-group"><label>Position Override</label><select id="search-pos"><option value="">Auto</option><option value="C">C</option><option value="1B">1B</option><option value="2B">2B</option><option value="3B">3B</option><option value="SS">SS</option><option value="LF">LF</option><option value="CF">CF</option><option value="RF">RF</option><option value="DH">DH</option><option value="SP">SP</option><option value="RP">RP</option><option value="CP">CP</option></select></div>
            </div>
        </div>
        <button class="btn-calc btn-search" id="btn-search" disabled>üîç Search & Convert</button>
    </div>

    <div id="hitter-form" class="player-form hidden">
        <div class="card">
            <div class="card-title">Player Info</div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Name</label><input type="text" id="h-name" placeholder="Player name"></div>
                <div class="form-group"><label>Position</label><select id="h-pos"><option value="C">C</option><option value="1B">1B</option><option value="2B">2B</option><option value="3B">3B</option><option value="SS">SS</option><option value="LF">LF</option><option value="CF" selected>CF</option><option value="RF">RF</option><option value="DH">DH</option></select></div>
                <div class="form-group"><label>Bats</label><select id="h-bats"><option value="R">Right</option><option value="L">Left</option><option value="S">Switch</option></select></div>
            </div>
            <div class="form-row cols-3" style="margin-top:12px"><div class="form-group"><label>Tier</label><select id="h-tier"><option value="Diamond">Diamond</option><option value="Gold" selected>Gold</option><option value="Silver">Silver</option><option value="Bronze">Bronze</option><option value="Common">Common</option></select></div></div>
        </div>
        <div class="card">
            <div class="card-title">Batting Stats</div>
            <div class="form-row">
                <div class="form-group"><label>AVG</label><input type="number" id="h-avg" step="0.001" value="0.265"></div>
                <div class="form-group"><label>OBP</label><input type="number" id="h-obp" step="0.001" value="0.340"></div>
                <div class="form-group"><label>SLG</label><input type="number" id="h-slg" step="0.001" value="0.450"></div>
                <div class="form-group"><label>ISO</label><input type="number" id="h-iso" step="0.001" class="auto-calc" readonly></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>PA</label><input type="number" id="h-pa" value="600"></div>
                <div class="form-group"><label>HR</label><input type="number" id="h-hr" value="25"></div>
                <div class="form-group"><label>BB</label><input type="number" id="h-bb" value="55"></div>
                <div class="form-group"><label>SO</label><input type="number" id="h-so" value="130"></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>SB</label><input type="number" id="h-sb" value="10"></div>
                <div class="form-group"><label>CS</label><input type="number" id="h-cs" value="3"></div>
                <div class="form-group"><label>3B</label><input type="number" id="h-3b" value="2"></div>
                <div class="form-group"><label>wRC+</label><input type="number" id="h-wrc" placeholder="Optional"></div>
            </div>
        </div>
    </div>

    <div id="sp-form" class="player-form hidden">
        <div class="card">
            <div class="card-title">Starting Pitcher</div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Name</label><input type="text" id="sp-name" placeholder="Player name"></div>
                <div class="form-group"><label>Throws</label><select id="sp-throws"><option value="R">Right</option><option value="L">Left</option></select></div>
                <div class="form-group"><label>Tier</label><select id="sp-tier"><option value="Diamond">Diamond</option><option value="Gold" selected>Gold</option><option value="Silver">Silver</option><option value="Bronze">Bronze</option><option value="Common">Common</option></select></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Stats</div>
            <div class="form-row">
                <div class="form-group"><label>ERA</label><input type="number" id="sp-era" step="0.01" value="3.50"></div>
                <div class="form-group"><label>IP</label><input type="number" id="sp-ip" step="0.1" value="180"></div>
                <div class="form-group"><label>H</label><input type="number" id="sp-h" value="160"></div>
                <div class="form-group"><label>BB</label><input type="number" id="sp-bb" value="50"></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>SO</label><input type="number" id="sp-so" value="180"></div>
                <div class="form-group"><label>HR</label><input type="number" id="sp-hr" value="22"></div>
                <div class="form-group"><label>Velo</label><input type="number" id="sp-velo" step="0.1" value="94.0"></div>
                <div class="form-group"><label>Stuff+</label><input type="number" id="sp-stuff" placeholder="Optional"></div>
            </div>
        </div>
    </div>

    <div id="rp-form" class="player-form hidden">
        <div class="card">
            <div class="card-title">Relief Pitcher</div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Name</label><input type="text" id="rp-name" placeholder="Player name"></div>
                <div class="form-group"><label>Role</label><select id="rp-role"><option value="RP">RP</option><option value="CP">Closer</option></select></div>
                <div class="form-group"><label>Tier</label><select id="rp-tier"><option value="Diamond">Diamond</option><option value="Gold" selected>Gold</option><option value="Silver">Silver</option><option value="Bronze">Bronze</option><option value="Common">Common</option></select></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">Stats</div>
            <div class="form-row">
                <div class="form-group"><label>ERA</label><input type="number" id="rp-era" step="0.01" value="3.00"></div>
                <div class="form-group"><label>IP</label><input type="number" id="rp-ip" step="0.1" value="65"></div>
                <div class="form-group"><label>H</label><input type="number" id="rp-h" value="50"></div>
                <div class="form-group"><label>BB</label><input type="number" id="rp-bb" value="22"></div>
            </div>
            <div class="form-row" style="margin-top:12px">
                <div class="form-group"><label>SO</label><input type="number" id="rp-so" value="75"></div>
                <div class="form-group"><label>HR</label><input type="number" id="rp-hr" value="6"></div>
                <div class="form-group"><label>Velo</label><input type="number" id="rp-velo" step="0.1" value="96.0"></div>
                <div class="form-group"><label>SV</label><input type="number" id="rp-sv" value="0"></div>
            </div>
        </div>
    </div>

    <button class="btn-calc hidden" id="btn-calc">Convert to The Show Ratings</button>

    <div class="result" id="result">
        <div class="result-header">
            <div class="player-info"><h2 id="r-name">Player</h2><p class="meta" id="r-meta">CF ¬∑ Hitter</p></div>
            <div class="overall-box"><div class="overall-num" id="r-ovr">99</div><div class="rarity rarity-diamond" id="r-rarity">Diamond</div></div>
        </div>
        <div class="real-stats-box hidden" id="real-stats-box"></div>
        <div class="section-head" id="s1-title">Hitting</div>
        <div class="attrs" id="s1-attrs"></div>
        <div class="section-head" id="s2-title">Fielding</div>
        <div class="attrs" id="s2-attrs"></div>
        <div class="formula-box" id="formula-box"></div>
        <div class="est-box hidden" id="est-box"></div>
    </div>

    <details class="info"><summary>How This Works</summary>
        <div class="info-body">
            <p><strong>üîç Search:</strong> Powered by <span class="hl">Lahman Database</span> with 24,270 players (1871-2024) including Negro Leagues!</p>
            <p style="margin-top:8px">Overall formula derived from <span class="hl">3,644 players</span> with <span class="hl">95% accuracy</span>.</p>
            <p style="margin-top:8px"><strong>Note:</strong> The lahman_data.js file must be in the same folder as this HTML file.</p>
        </div>
    </details>
</div>

<script src="lahman_data.js"></script>
<script>
// ============ CONVERSION FUNCTIONS (unchanged 95% accuracy) ============
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
function scale(val,minS,maxS,minR,maxR){if(val===null||val===undefined||isNaN(val))return Math.round((minR+maxR)/2);return clamp(Math.round(minR+((val-minS)/(maxS-minS))*(maxR-minR)),0,125)}
function getVal(id){const el=document.getElementById(id);if(!el)return null;const v=parseFloat(el.value);return(isNaN(v)||el.value.trim()==='')?null:v}
function getValOr(id,def){const v=getVal(id);return v!==null?v:def}

function convertHitter(stats){
    const attrs={},est=[];
    if(stats.iso===null)stats.iso=stats.slg-stats.avg;
    const kPct=(stats.so/stats.pa)*100,bbPct=(stats.bb/stats.pa)*100;
    if(stats.wrc===null){stats.wrc=Math.round(((stats.obp+stats.slg)/0.710)*100);est.push('wRC+')}
    if(stats.sprint===null){const sbPer=stats.sb/(stats.pa/600),triPer=stats.triples/(stats.pa/600),sbSucc=stats.sb/Math.max(1,stats.sb+stats.cs);stats.sprint=clamp(26+sbPer*0.08+triPer*0.5+sbSucc*2,23,31);est.push('Sprint')}
    const avgBase=scale(stats.avg,0.180,0.330,25,105),kBonus=scale(kPct,35,8,-15,15),wrcBonus=scale(stats.wrc,70,160,-10,20);
    const baseCon=clamp(avgBase+kBonus+wrcBonus,20,125);
    if(stats.bats==='S'){attrs.conR=baseCon;attrs.conL=baseCon}
    else if(stats.bats==='L'){attrs.conR=clamp(baseCon+8,20,125);attrs.conL=clamp(baseCon-12,20,125)}
    else{attrs.conR=clamp(baseCon-8,20,125);attrs.conL=clamp(baseCon+12,20,125)}
    est.push('Splits');
    const isoBase=scale(stats.iso,0.080,0.300,25,115),hrBonus=scale(stats.hr,5,45,-10,20);
    const basePow=clamp(isoBase+hrBonus,15,125);
    if(stats.bats==='S'){attrs.powR=basePow;attrs.powL=basePow}
    else if(stats.bats==='L'){attrs.powR=clamp(basePow+10,15,125);attrs.powL=clamp(basePow-15,15,125)}
    else{attrs.powR=clamp(basePow-10,15,125);attrs.powL=clamp(basePow+15,15,125)}
    attrs.vision=scale(kPct,35,8,25,110);
    attrs.discipline=clamp(scale(bbPct,4,18,30,115)+scale(stats.obp-stats.avg,0.04,0.12,-10,15),20,125);
    attrs.clutch=scale(stats.wrc,70,150,40,100);
    attrs.speed=scale(stats.sprint,23,30.5,10,99);
    const sbSucc=stats.sb/Math.max(1,stats.sb+stats.cs);
    attrs.stealing=clamp(scale(stats.sb,0,50,5,90)+scale(sbSucc,0.5,0.9,-10,20),5,99);
    attrs.baserunning=clamp(Math.round(attrs.speed*0.6+attrs.stealing*0.4),5,99);
    const posDef={C:65,'1B':55,'2B':70,'3B':65,SS:75,LF:60,CF:70,RF:60,DH:40};
    attrs.fielding=posDef[stats.pos]||60;est.push('Fielding');
    const posArm={C:70,'1B':55,'2B':60,'3B':70,SS:75,LF:65,CF:70,RF:80,DH:50};
    attrs.armStr=posArm[stats.pos]||65;
    attrs.armAcc=clamp(Math.round(attrs.fielding*0.6+attrs.armStr*0.3+10),30,99);
    attrs.reaction=clamp(Math.round(attrs.fielding*0.5+attrs.speed*0.3+15),25,99);
    return{attrs,est}
}

function convertPitcher(stats,isSP){
    const attrs={},est=[];const ip=stats.ip||1;
    stats.whip=(stats.h+stats.bb)/ip;stats.k9=(stats.so*9)/ip;stats.bb9=(stats.bb*9)/ip;stats.hr9=(stats.hr*9)/ip;stats.h9=(stats.h*9)/ip;
    if(stats.fip===null){stats.fip=((13*stats.hr)+(3*stats.bb)-(2*stats.so))/ip+3.10;est.push('FIP')}
    if(stats.stuff===null){stats.stuff=Math.round(100+(stats.k9-8)*8+(stats.velo-93)*3);est.push('Stuff+')}
    attrs.h9=clamp(scale(stats.h9,11,5.5,30,110)+scale(stats.whip,1.5,0.9,-15,20),25,125);
    attrs.k9=clamp(scale(stats.k9,5,13,30,110)+scale(stats.stuff,80,140,-15,25),25,125);
    attrs.bb9=clamp(scale(stats.bb9,5.5,1.0,25,110),20,125);
    attrs.hr9=clamp(scale(stats.hr9,2.0,0.4,25,105)+scale(stats.fip,5.0,2.5,-10,15),20,125);
    attrs.clutch=clamp(scale(stats.era,5.5,2.0,30,110),25,125);
    attrs.velocity=scale(stats.velo,85,102,30,99);
    attrs.control=clamp(Math.round(attrs.bb9*0.7+25),25,99);
    attrs.break=scale(stats.stuff,70,150,40,110);
    attrs.stamina=isSP?scale(ip,100,220,55,99):scale(ip,30,80,20,45);
    return{attrs,est}
}

const hFormulas={'C_Diamond':{s:0.55,b:46.25},'C_Gold':{s:0.55,b:47.25},'C_Silver':{s:0.55,b:45},'C_Bronze':{s:0.55,b:43},'C_Common':{s:0.55,b:38.75},'1B_Diamond':{s:0.55,b:46.5},'1B_Gold':{s:0.55,b:43.75},'1B_Silver':{s:0.55,b:41},'1B_Bronze':{s:0.55,b:38.75},'1B_Common':{s:0.695,b:26.75},'2B_Diamond':{s:0.56,b:44},'2B_Gold':{s:0.55,b:43.5},'2B_Silver':{s:0.55,b:42},'2B_Bronze':{s:0.55,b:39},'2B_Common':{s:0.65,b:30},'3B_Diamond':{s:0.61,b:39.25},'3B_Gold':{s:0.55,b:42.5},'3B_Silver':{s:0.55,b:41.5},'3B_Bronze':{s:0.55,b:38.25},'3B_Common':{s:0.55,b:34.5},'SS_Diamond':{s:0.55,b:45},'SS_Gold':{s:0.55,b:43},'SS_Silver':{s:0.55,b:41},'SS_Bronze':{s:0.565,b:39.25},'SS_Common':{s:0.55,b:35.25},'LF_Diamond':{s:0.55,b:44.5},'LF_Gold':{s:0.55,b:42.5},'LF_Silver':{s:0.55,b:40.5},'LF_Bronze':{s:0.55,b:38.75},'LF_Common':{s:0.655,b:30.25},'CF_Diamond':{s:0.55,b:45.75},'CF_Gold':{s:0.55,b:44.75},'CF_Silver':{s:0.55,b:43.25},'CF_Bronze':{s:0.55,b:40},'CF_Common':{s:0.71,b:29},'RF_Diamond':{s:0.55,b:45.25},'RF_Gold':{s:0.55,b:43.75},'RF_Silver':{s:0.55,b:42.5},'RF_Bronze':{s:0.55,b:39.25},'RF_Common':{s:0.55,b:35.5},'DH_Diamond':{s:0.55,b:44},'DH_Gold':{s:0.75,b:30},'DH_Silver':{s:0.75,b:30},'DH_Bronze':{s:0.75,b:30},'DH_Common':{s:0.75,b:30}};
const spFormulas={Diamond:{s:0.68,b:24.5,stam:0.08},Gold:{s:0.65,b:21.5,stam:0.135},Silver:{s:0.65,b:24.5,stam:0.075},Bronze:{s:0.65,b:22.75,stam:0.08},Common:{s:0.66,b:20.25,stam:0.075}};
const rpFormulas={Diamond:{s:0.66,b:29.75},Gold:{s:0.615,b:29.75},Silver:{s:0.605,b:30},Bronze:{s:0.61,b:26.5},Common:{s:0.625,b:22.25}};
const cpFormulas={Diamond:{s:0.765,b:19.25},Gold:{s:0.74,b:19.75},Silver:{s:0.7,b:18.75},Bronze:{s:0.7,b:16.25},Common:{s:0.7,b:17.5}};

function getRarity(ovr){if(ovr>=85)return'Diamond';if(ovr>=80)return'Gold';if(ovr>=75)return'Silver';if(ovr>=65)return'Bronze';return'Common'}
function calcHitterOvr(attrs,pos,tier){
    const core=[attrs.conR,attrs.conL,attrs.powR,attrs.powL,attrs.vision,attrs.discipline,attrs.clutch,attrs.fielding,attrs.speed];
    const coreAvg=core.reduce((a,b)=>a+b,0)/9,avgPow=(attrs.powR+attrs.powL)/2;
    const f=hFormulas[pos+'_'+tier]||{s:0.75,b:30};
    let ovr=f.s*coreAvg+f.b;if(avgPow>90)ovr+=(avgPow-90)*0.11;
    return{ovr:Math.min(99,Math.round(ovr)),rarity:getRarity(Math.min(99,Math.round(ovr))),coreAvg:coreAvg.toFixed(1),f}
}
function calcPitcherOvr(attrs,type,tier){
    const core=[Math.min(attrs.h9,99),Math.min(attrs.k9,99),Math.min(attrs.bb9,99),Math.min(attrs.hr9,99),Math.min(attrs.clutch,99),attrs.control,attrs.velocity,Math.min(attrs.break,99)];
    const coreAvg=core.reduce((a,b)=>a+b,0)/8;
    const formulas=type==='SP'?spFormulas:(type==='CP'?cpFormulas:rpFormulas);
    const f=formulas[tier];let ovr=f.s*coreAvg+f.b;if(type==='SP')ovr+=attrs.stamina*f.stam;
    return{ovr:Math.min(99,Math.round(ovr)),rarity:getRarity(Math.min(99,Math.round(ovr))),coreAvg:coreAvg.toFixed(1),f,stam:attrs.stamina}
}

// ============ LAHMAN DATABASE ============
let dbLoaded = false;
function initDB(){
    const status=document.getElementById('db-status');
    try{
        if(typeof PPL==='undefined'||typeof BAT==='undefined'){
            throw new Error('Data not loaded');
        }
        dbLoaded=true;
        status.textContent='‚úÖ Loaded '+PPL.length.toLocaleString()+' players (1871-2024)';
        status.classList.remove('loading','error');
        document.getElementById('btn-search').disabled=false;
    }catch(e){
        status.classList.remove('loading');status.classList.add('error');
        status.innerHTML='‚ùå Database not loaded. Place <strong>lahman_data.js</strong> in the same folder as this HTML file.';
    }
}

function normalizeStr(s){return(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}

function searchPlayers(q){
    if(!dbLoaded||!q||q.length<2)return[];
    const nq=normalizeStr(q),pts=nq.split(/\s+/);
    // PPL format: [playerID, firstName, lastName, bats, throws]
    return PPL.filter(p=>{
        const fn=normalizeStr(p[1]),ln=normalizeStr(p[2]),full=fn+' '+ln;
        return pts.length===1?(fn.includes(pts[0])||ln.includes(pts[0])):pts.every(pt=>full.includes(pt))
    }).slice(0,15)
}

function getPlayerYears(pid){
    const batYrs=BAT.filter(b=>b[0]===pid).map(b=>b[1]);
    const pitYrs=PIT.filter(p=>p[0]===pid).map(p=>p[1]);
    const yrs=[...new Set([...batYrs,...pitYrs])].sort((a,b)=>a-b);
    return yrs.length?yrs[0]+'-'+yrs[yrs.length-1]:''
}

function getBatting(pid,yr){
    // BAT: [playerID, year, G, AB, H, 2B, 3B, HR, BB, SO, SB, CS, HBP, SF]
    const rows=BAT.filter(b=>b[0]===pid&&b[1]===yr);if(!rows.length)return null;
    let g=0,ab=0,h=0,d=0,tr=0,hr=0,bb=0,so=0,sb=0,cs=0,hbp=0,sf=0;
    rows.forEach(r=>{g+=r[2];ab+=r[3];h+=r[4];d+=r[5];tr+=r[6];hr+=r[7];bb+=r[8];so+=r[9];sb+=r[10];cs+=r[11];hbp+=r[12];sf+=r[13]});
    const pa=ab+bb+hbp+sf,avg=ab>0?h/ab:0,obp=pa>0?(h+bb+hbp)/pa:0,tb=h+d+2*tr+3*hr,slg=ab>0?tb/ab:0;
    return{g,ab,h,d,tr,hr,bb,so,sb,cs,hbp,sf,pa,avg,obp,slg,iso:slg-avg}
}

function getPitching(pid,yr){
    // PIT: [playerID, year, W, L, G, GS, SV, IPouts, H, ER, HR, BB, SO]
    const rows=PIT.filter(p=>p[0]===pid&&p[1]===yr);if(!rows.length)return null;
    let w=0,l=0,g=0,gs=0,sv=0,ipo=0,h=0,er=0,hr=0,bb=0,so=0;
    rows.forEach(r=>{w+=r[2];l+=r[3];g+=r[4];gs+=r[5];sv+=r[6];ipo+=r[7];h+=r[8];er+=r[9];hr+=r[10];bb+=r[11];so+=r[12]});
    const ip=ipo/3;
    return{w,l,g,gs,sv,ip,h,er,hr,bb,so,era:ip>0?(er*9)/ip:0,whip:ip>0?(h+bb)/ip:0,k9:ip>0?(so*9)/ip:0}
}

function getPosition(pid,yr){
    // FLD: [playerID, year, position]
    const rows=FLD.filter(f=>f[0]===pid&&f[1]===yr);
    if(!rows.length)return'DH';
    // Just take the first one (already sorted by games in build script)
    const pos=rows[0][2];
    return{C:'C','1B':'1B','2B':'2B','3B':'3B',SS:'SS',LF:'LF',CF:'CF',RF:'RF',OF:'CF'}[pos]||'DH'
}

function estVelo(yr,k9){let v=93;if(yr<1920)v=88;else if(yr<1950)v=90;else if(yr<1970)v=92;else if(yr<1990)v=91;else if(yr<2010)v=93;else v=94;if(k9>10)v+=2;else if(k9>8)v+=1;return v}
function autoTier(st,isP){if(isP){if(st.era<2.5&&st.ip>100)return'Diamond';if(st.era<3.5)return'Gold';if(st.era<4.2)return'Silver';if(st.era<5)return'Bronze';return'Common'}else{const ops=st.obp+st.slg;if(ops>0.95)return'Diamond';if(ops>0.8)return'Gold';if(ops>0.72)return'Silver';if(ops>0.65)return'Bronze';return'Common'}}

// ============ UI ============
let curType='search',selectedPlayer=null;

document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',function(){
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));this.classList.add('active');
        curType=this.dataset.type;
        document.querySelectorAll('.player-form').forEach(f=>f.classList.add('hidden'));
        document.getElementById(curType+'-form').classList.remove('hidden');
        document.getElementById('result').classList.remove('show');
        document.getElementById('btn-calc').classList.toggle('hidden',curType==='search');
    })
});

const searchIn=document.getElementById('search-name'),searchRes=document.getElementById('search-results');
let searchTO;
searchIn.addEventListener('input',function(){
    clearTimeout(searchTO);const q=this.value.trim();
    searchTO=setTimeout(()=>{
        if(q.length<2){searchRes.classList.remove('show');return}
        const res=searchPlayers(q);
        // PPL format: [playerID, firstName, lastName, bats, throws]
        searchRes.innerHTML=res.length?res.map(p=>`<div class="search-result" data-id="${p[0]}" data-fn="${p[1]}" data-ln="${p[2]}" data-bats="${p[3]}" data-throws="${p[4]}"><span class="name">${p[1]} ${p[2]}</span><span class="years">${getPlayerYears(p[0])}</span></div>`).join(''):'<div class="search-result"><span class="name">No players found</span></div>';
        searchRes.classList.add('show')
    },200)
});
searchRes.addEventListener('click',e=>{const r=e.target.closest('.search-result');if(r&&r.dataset.id){selectedPlayer={id:r.dataset.id,fn:r.dataset.fn,ln:r.dataset.ln,bats:r.dataset.bats,throws:r.dataset.throws};searchIn.value=selectedPlayer.fn+' '+selectedPlayer.ln;searchRes.classList.remove('show')}});
document.addEventListener('click',e=>{if(!e.target.closest('.search-box'))searchRes.classList.remove('show')});

['h-avg','h-slg'].forEach(id=>{document.getElementById(id).addEventListener('input',()=>{const a=getVal('h-avg'),s=getVal('h-slg');if(a!==null&&s!==null)document.getElementById('h-iso').value=(s-a).toFixed(3)})});

document.getElementById('btn-search').addEventListener('click',searchConvert);
document.getElementById('btn-calc').addEventListener('click',()=>{if(curType==='hitter')calcHitter();else if(curType==='sp')calcSP();else calcRP()});

function searchConvert(){
    if(!selectedPlayer){alert('Select a player');return}
    const yr=+document.getElementById('search-year').value;if(!yr||yr<1871||yr>2024){alert('Enter year 1871-2024');return}
    const pit=getPitching(selectedPlayer.id,yr),bat=getBatting(selectedPlayer.id,yr);
    const oPos=document.getElementById('search-pos').value;
    let isP=['SP','RP','CP'].includes(oPos);if(!oPos&&pit&&pit.ip>30)isP=true;
    if(isP&&pit)convertSearchPit(selectedPlayer,yr,pit,oPos);else if(bat)convertSearchHit(selectedPlayer,yr,bat,oPos);else alert('No stats for '+selectedPlayer.fn+' '+selectedPlayer.ln+' in '+yr)
}

function convertSearchHit(player,yr,real,oPos){
    const pos=oPos||getPosition(player.id,yr),tier=document.getElementById('search-tier').value||autoTier(real,false);
    const stats={avg:real.avg,obp:real.obp,slg:real.slg,iso:real.iso,pa:real.pa,hr:real.hr,bb:real.bb,so:real.so,sb:real.sb,cs:real.cs,triples:real.tr,sprint:null,wrc:null,bats:player.bats||'R',pos};
    const{attrs,est}=convertHitter(stats),res=calcHitterOvr(attrs,pos,tier);
    const realHtml=`<strong>${yr}:</strong> .${(real.avg*1000).toFixed(0).padStart(3,'0')}/.${(real.obp*1000).toFixed(0).padStart(3,'0')}/.${(real.slg*1000).toFixed(0).padStart(3,'0')} ¬∑ ${real.hr} HR ¬∑ ${real.sb} SB ¬∑ ${real.g} G`;
    showHitterResult(player.fn+' '+player.ln,pos,attrs,res,est,realHtml)
}

function convertSearchPit(player,yr,real,oPos){
    const isSP=real.gs>real.g/2,posType=oPos||(isSP?'SP':(real.sv>10?'CP':'RP'));
    const tier=document.getElementById('search-tier').value||autoTier(real,true);
    const oVelo=getVal('search-velo'),velo=oVelo||estVelo(yr,real.k9);
    const stats={era:real.era,ip:real.ip,h:real.h,bb:real.bb,so:real.so,hr:real.hr,velo,stuff:null,fip:null};
    const{attrs,est}=convertPitcher(stats,posType==='SP'),res=calcPitcherOvr(attrs,posType,tier);
    est.push('Velo: '+velo.toFixed(0)+' mph (est)');
    const realHtml=`<strong>${yr}:</strong> ${real.w}-${real.l} ¬∑ ${real.era.toFixed(2)} ERA ¬∑ ${real.ip.toFixed(0)} IP ¬∑ ${real.so} SO ¬∑ ${real.whip.toFixed(2)} WHIP`;
    showPitcherResult(player.fn+' '+player.ln,posType,attrs,res,est,realHtml)
}

function calcHitter(){
    const stats={avg:getVal('h-avg'),obp:getVal('h-obp'),slg:getVal('h-slg'),iso:getVal('h-iso'),pa:getValOr('h-pa',600),hr:getValOr('h-hr',0),bb:getValOr('h-bb',0),so:getValOr('h-so',0),sb:getValOr('h-sb',0),cs:getValOr('h-cs',0),triples:getValOr('h-3b',0),sprint:null,wrc:getVal('h-wrc'),bats:document.getElementById('h-bats').value,pos:document.getElementById('h-pos').value};
    const{attrs,est}=convertHitter(stats),res=calcHitterOvr(attrs,stats.pos,document.getElementById('h-tier').value);
    showHitterResult(document.getElementById('h-name').value||'Player',stats.pos,attrs,res,est)
}

function calcSP(){
    const stats={era:getVal('sp-era'),ip:getVal('sp-ip'),h:getValOr('sp-h',0),bb:getValOr('sp-bb',0),so:getValOr('sp-so',0),hr:getValOr('sp-hr',0),velo:getValOr('sp-velo',93),stuff:getVal('sp-stuff'),fip:null};
    const{attrs,est}=convertPitcher(stats,true),res=calcPitcherOvr(attrs,'SP',document.getElementById('sp-tier').value);
    showPitcherResult(document.getElementById('sp-name').value||'Player','SP',attrs,res,est)
}

function calcRP(){
    const stats={era:getVal('rp-era'),ip:getVal('rp-ip'),h:getValOr('rp-h',0),bb:getValOr('rp-bb',0),so:getValOr('rp-so',0),hr:getValOr('rp-hr',0),velo:getValOr('rp-velo',95),stuff:null,fip:null};
    const role=document.getElementById('rp-role').value;
    const{attrs,est}=convertPitcher(stats,false),res=calcPitcherOvr(attrs,role,document.getElementById('rp-tier').value);
    showPitcherResult(document.getElementById('rp-name').value||'Player',role,attrs,res,est)
}

function attrClass(v){if(v>=85)return'v-elite';if(v>=70)return'v-good';if(v>=50)return'v-avg';return'v-low'}

function showHitterResult(name,pos,attrs,res,est,realHtml){
    document.getElementById('r-name').textContent=name;
    document.getElementById('r-meta').textContent=pos+' ¬∑ Hitter';
    document.getElementById('r-ovr').textContent=res.ovr;
    const badge=document.getElementById('r-rarity');badge.textContent=res.rarity;badge.className='rarity rarity-'+res.rarity.toLowerCase();
    document.getElementById('s1-title').textContent='Hitting';
    document.getElementById('s1-attrs').innerHTML=`<div class="attr"><div class="attr-name">Con R</div><div class="attr-val ${attrClass(attrs.conR)}">${attrs.conR}</div></div><div class="attr"><div class="attr-name">Con L</div><div class="attr-val ${attrClass(attrs.conL)}">${attrs.conL}</div></div><div class="attr"><div class="attr-name">Pow R</div><div class="attr-val ${attrClass(attrs.powR)}">${attrs.powR}</div></div><div class="attr"><div class="attr-name">Pow L</div><div class="attr-val ${attrClass(attrs.powL)}">${attrs.powL}</div></div><div class="attr"><div class="attr-name">Vision</div><div class="attr-val ${attrClass(attrs.vision)}">${attrs.vision}</div></div><div class="attr"><div class="attr-name">Disc</div><div class="attr-val ${attrClass(attrs.discipline)}">${attrs.discipline}</div></div><div class="attr"><div class="attr-name">Clutch</div><div class="attr-val ${attrClass(attrs.clutch)}">${attrs.clutch}</div></div>`;
    document.getElementById('s2-title').textContent='Fielding & Speed';
    document.getElementById('s2-attrs').innerHTML=`<div class="attr"><div class="attr-name">Field</div><div class="attr-val ${attrClass(attrs.fielding)}">${attrs.fielding}</div></div><div class="attr"><div class="attr-name">Arm</div><div class="attr-val ${attrClass(attrs.armStr)}">${attrs.armStr}</div></div><div class="attr"><div class="attr-name">React</div><div class="attr-val ${attrClass(attrs.reaction)}">${attrs.reaction}</div></div><div class="attr"><div class="attr-name">Speed</div><div class="attr-val ${attrClass(attrs.speed)}">${attrs.speed}</div></div><div class="attr"><div class="attr-name">Steal</div><div class="attr-val ${attrClass(attrs.stealing)}">${attrs.stealing}</div></div><div class="attr"><div class="attr-name">BsRun</div><div class="attr-val ${attrClass(attrs.baserunning)}">${attrs.baserunning}</div></div>`;
    const avgPow=(attrs.powR+attrs.powL)/2;let ft=`Core: ${res.coreAvg} ‚Üí ${res.f.s}√ó${res.coreAvg}+${res.f.b}`;if(avgPow>90)ft+=' +pwr';ft+=` = ${res.ovr}`;
    document.getElementById('formula-box').textContent=ft;
    const realBox=document.getElementById('real-stats-box');if(realHtml){realBox.innerHTML=realHtml;realBox.classList.remove('hidden')}else{realBox.classList.add('hidden')}
    const eb=document.getElementById('est-box');if(est.length>0){eb.textContent='‚ö†Ô∏è Est: '+est.join(' ¬∑ ');eb.classList.remove('hidden')}else{eb.classList.add('hidden')}
    document.getElementById('result').classList.add('show')
}

function showPitcherResult(name,type,attrs,res,est,realHtml){
    document.getElementById('r-name').textContent=name;
    document.getElementById('r-meta').textContent=type+' ¬∑ '+(type==='SP'?'Starter':type==='CP'?'Closer':'Reliever');
    document.getElementById('r-ovr').textContent=res.ovr;
    const badge=document.getElementById('r-rarity');badge.textContent=res.rarity;badge.className='rarity rarity-'+res.rarity.toLowerCase();
    document.getElementById('s1-title').textContent='Pitching';
    document.getElementById('s1-attrs').innerHTML=`<div class="attr"><div class="attr-name">H/9</div><div class="attr-val ${attrClass(Math.min(attrs.h9,99))}">${attrs.h9}</div></div><div class="attr"><div class="attr-name">K/9</div><div class="attr-val ${attrClass(Math.min(attrs.k9,99))}">${attrs.k9}</div></div><div class="attr"><div class="attr-name">BB/9</div><div class="attr-val ${attrClass(Math.min(attrs.bb9,99))}">${attrs.bb9}</div></div><div class="attr"><div class="attr-name">HR/9</div><div class="attr-val ${attrClass(Math.min(attrs.hr9,99))}">${attrs.hr9}</div></div><div class="attr"><div class="attr-name">Clutch</div><div class="attr-val ${attrClass(Math.min(attrs.clutch,99))}">${attrs.clutch}</div></div>`;
    document.getElementById('s2-title').textContent='Arsenal';
    document.getElementById('s2-attrs').innerHTML=`<div class="attr"><div class="attr-name">Velo</div><div class="attr-val ${attrClass(attrs.velocity)}">${attrs.velocity}</div></div><div class="attr"><div class="attr-name">Ctrl</div><div class="attr-val ${attrClass(attrs.control)}">${attrs.control}</div></div><div class="attr"><div class="attr-name">Break</div><div class="attr-val ${attrClass(Math.min(attrs.break,99))}">${attrs.break}</div></div><div class="attr"><div class="attr-name">Stam</div><div class="attr-val ${attrClass(attrs.stamina)}">${attrs.stamina}</div></div>`;
    let ft=`Core: ${res.coreAvg} ‚Üí ${res.f.s}√ó${res.coreAvg}+${res.f.b}`;if(type==='SP')ft+=` +(${res.stam}√ó${res.f.stam})`;ft+=` = ${res.ovr}`;
    document.getElementById('formula-box').textContent=ft;
    const realBox=document.getElementById('real-stats-box');if(realHtml){realBox.innerHTML=realHtml;realBox.classList.remove('hidden')}else{realBox.classList.add('hidden')}
    const eb=document.getElementById('est-box');if(est.length>0){eb.textContent='‚ö†Ô∏è Est: '+est.join(' ¬∑ ');eb.classList.remove('hidden')}else{eb.classList.add('hidden')}
    document.getElementById('result').classList.add('show')
}

// Init
setTimeout(initDB,100);
(function(){const a=getVal('h-avg'),s=getVal('h-slg');if(a!==null&&s!==null)document.getElementById('h-iso').value=(s-a).toFixed(3)})();
</script>
</body>
</html>
